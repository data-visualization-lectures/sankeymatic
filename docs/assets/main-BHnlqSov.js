(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const x of document.querySelectorAll('link[rel="modulepreload"]'))N(x);new MutationObserver(x=>{for(const M of x)if(M.type==="childList")for(const U of M.addedNodes)U.tagName==="LINK"&&U.rel==="modulepreload"&&N(U)}).observe(document,{childList:!0,subtree:!0});function g(x){const M={};return x.integrity&&(M.integrity=x.integrity),x.referrerPolicy&&(M.referrerPolicy=x.referrerPolicy),x.crossOrigin==="use-credentials"?M.credentials="include":x.crossOrigin==="anonymous"?M.credentials="omit":M.credentials="same-origin",M}function N(x){if(x.ep)return;x.ep=!0;const M=g(x);fetch(x.href,M)}})();(function(){if(window.location.search){const X=new URLSearchParams(window.location.search).get("project_id");X&&(window.SKM_PROJECT_ID=X,console.log("Rescued project_id:",X))}})();window.skmSettings=new Map([["size_w",["whole",600,[40]]],["size_h",["whole",600,[40]]],["margin_l",["contained",12,[0,"w"]]],["margin_r",["contained",12,[0,"w"]]],["margin_t",["contained",18,[0,"h"]]],["margin_b",["contained",20,[0,"h"]]],["bg_color",["color","#ffffff",[]]],["bg_transparent",["yn","n",[]]],["node_w",["contained",9,[0,"w"]]],["node_h",["whole",50,[0,100]]],["node_spacing",["whole",85,[0,100]]],["node_border",["contained",0,[0,"w"]]],["node_theme",["radio","none",["a","b","c","d","none"]]],["node_color",["color","#888888",[]]],["node_opacity",["decimal",1,[]]],["flow_curvature",["decimal",.5,[]]],["flow_inheritfrom",["radio","none",["source","target","outside-in","none"]]],["flow_color",["color","#999999",[]]],["flow_opacity",["decimal",.45,[]]],["layout_order",["radio","automatic",["automatic","exact"]]],["layout_justifyorigins",["yn","n",[]]],["layout_justifyends",["yn","n",[]]],["layout_reversegraph",["yn","n",[]]],["layout_attachincompletesto",["radio","nearest",["leading","nearest","trailing"]]],["labels_color",["color","#000000",[]]],["labels_highlight",["decimal",.55,[]]],["labels_fontface",["radio","sans-serif",["monospace","sans-serif","serif"]]],["labelname_appears",["yn","y",[]]],["labelname_size",["whole",16,[6]]],["labelname_weight",["radio","400",["100","400","700"]]],["labelvalue_appears",["yn","y",[]]],["labelvalue_fullprecision",["yn","y",[]]],["labelposition_first",["radio","before",["before","after"]]],["labelposition_breakpoint",["breakpoint",9999,[2]]],["value_format",["list",",.",[",.",".,"," ."," ,","X.","X,"]]],["value_prefix",["text","",[0,99]]],["value_suffix",["text","",[0,99]]],["themeoffset_a",["whole",9,[0,9]]],["themeoffset_b",["whole",0,[0,9]]],["themeoffset_c",["whole",0,[0,7]]],["themeoffset_d",["whole",0,[0,11]]],["meta_listimbalances",["yn","y",[]]],["internal_iterations",["whole",25,[0,50]]],["internal_revealshadows",["yn","n",[]]]]);window.reWholeNumber=/^\d+$/;window.reDecimal=/^\d(?:.\d+)?$/;window.reCommentLine=/^(?:'|\/\/)/;window.reYesNo=/^(?:y|yes|n|no)/i;window.reYes=/^(?:y|yes)/i;window.reSettingsValue=/^((?:\w+\s*){1,2}) (#?[\w.-]+)$/;window.reSettingsText=/^((?:\w+\s*){1,2}) '(.*)'$/;window.reMoveLine=/^move (.+) (-?\d(?:.\d+)?), (-?\d(?:.\d+)?)$/;window.sourceHeaderPrefix="// SankeyMATIC diagram inputs -";window.sourceURLLine="// https://sankeymatic.com/build/";window.userDataMarker="// === Nodes and Flows ===";window.movesMarker="// === Moved Nodes ===";window.settingsMarker="// === Settings ===";window.settingsAppliedPrefix="// ✓ ";window.reNodeLine=/^:(.+) #([a-f0-9]{0,6})?(\.\d{1,4})?\s*(>>|<<)*\s*(>>|<<)*$/i;window.reFlowLine=/^(.+)\[([\d\s.+-]+)\](.+)$/;window.reFlowTargetWithSuffix=/^(.+)\s+(#\S+)$/;window.reColorPlusOpacity=/^#([a-f0-9]{3,6})?(\.\d{1,4})?$/i;window.reBareColor=/^(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.reRGBColor=/^#(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.colorGray60="#999";window.userInputsField="flows_in";window.IN=13;window.OUT=17;window.BEFORE=19;window.AFTER=23;window.fontMetrics={firefox:{"sans-serif":{dy:.35,top:.55,bot:.25,inner:.35,outer:.35,marginRight:1.4,marginAdjLeft:0},monospace:{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.48,marginAdjLeft:-.08},"*":{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.35,marginAdjLeft:-.05}},"*":{monospace:{dy:.28,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.45,marginAdjLeft:0},"*":{dy:.29,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.35,marginAdjLeft:0}}};window.highlightStyles={dark:{orig:{fill:"#fff",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#ffb",stroke:"#440",stroke_width:1,stroke_opacity:.7}},light:{orig:{fill:"#000",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#603",stroke:"#fff",stroke_width:1.7,stroke_opacity:.9}}};window.sampleDiagramRecipes=new Map([["default_budget",{name:"Basic Budget",flows:`// Enter Flows between Nodes, like this:
//         Source [AMOUNT] Target

Wages [1500] Budget
Other [250] Budget

Budget [450] Taxes
Budget [420] Housing
Budget [400] Food
Budget [295] Transportation
Budget [25] Savings

// You can set a Node's color, like this:
:Budget #708090
//            ...or a color for a single Flow:
Budget [160] Other Necessities #0F0

// Use the controls below to customize
// your diagram's appearance...`,settings:{size_w:600,node_w:9,node_h:50,node_spacing:85,node_theme:"a",flow_inheritfrom:"outside-in",layout_justifyends:"n",layout_order:"automatic",labelname_size:16,value_prefix:""}}],["election",{name:"Ranked Election",flows:`// Sample Ranked Election diagram

GH - Round 1 [300000] GH - Round 2
EF - Round 1 [220000] EF - Round 2
CD - Round 1 [200000] CD - Round 2
AB - Round 1 [10000] GH - Round 2
AB - Round 1 [25000] EF - Round 2
AB - Round 1 [20000] CD - Round 2

GH - Round 2 [310000] GH - Round 3
EF - Round 2 [245000] EF - Round 3
CD - Round 2 [50000] GH - Round 3
CD - Round 2 [95000] EF - Round 3

// This line sets a custom gray color:
:No further votes #555 <<
AB - Round 1 [20000] No further votes
CD - Round 2 [75000] No further votes`,settings:{size_w:700,node_w:9,node_h:76,node_spacing:85,node_theme:"a",flow_inheritfrom:"source",layout_justifyends:"n",layout_order:"exact",labelname_size:14,value_prefix:""}}],["job_search",{name:"Job Search",flows:`// Sample Job Search diagram:

Applications [4] Interview
Applications [9] Rejected
Applications [4] No Answer

Interview [2] 2nd Interview
Interview [2] No Offer

2nd Interview [2] Offer

Offer [1] Accepted
Offer [1] Declined`,settings:{size_w:700,node_w:5,node_h:50,node_spacing:50,node_theme:"a",flow_inheritfrom:"target",layout_justifyends:"n",layout_order:"automatic",labelname_size:14,value_prefix:""}}],["financial_results",{name:"Financial Results",flows:`Division A [900] Revenue
Division B [750] Revenue
Division C [150] Revenue

Revenue [1000] Gross Profit

Gross Profit [350] Operating Profit
Gross Profit [650] Operating Expenses

Operating Profit [260] Net Profit
Operating Profit [90] Tax

Operating Expenses [640] S G & Admin
Operating Expenses [10] Amortization

Revenue [800] Cost of Sales

// Profit - blue
:Gross Profit #48e <<
:Operating Profit #48e <<
:Net Profit #48e <<

// Expenses - rust
:Operating Expenses #d74 <<
:Tax #d74 <<
:S G & Admin #d74 <<
:Amortization #d74 <<

// Cost - grayish-gold
:Cost of Sales #e6cc91 <<

// main Revenue node: dark grey
:Revenue #444`,settings:{size_w:1e3,node_w:5,node_h:70,node_spacing:70,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"y",layout_order:"automatic",labelname_size:13,value_prefix:"$"}}],["simple_start",{name:"Start Simple",flows:`a [1] b
a [1] c`,settings:{size_w:600,node_w:12,node_h:50,node_spacing:80,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"n",layout_order:"automatic",labelname_size:15,value_prefix:""}}]]);(function(s){function g(t){return document.getElementById(t)}function N(t){return document.getElementById(t).value}s.togglePanel=t=>{const r=g(t),a=r.tagName==="SPAN"?"inline":"",i=r.style.display==="none"?{display:a,suffix:":",action:"–"}:{display:"none",suffix:"...",action:"+"};return r.style.display=i.display,g(`${t}_hint`).textContent=i.suffix,g(`${t}_indicator`).textContent=i.action,null};function x(t){return g(`${t}_val`)}s.labelNeverBreakpoint=9999,s.updateOutput=t=>{const r=N(t),a=x(t);switch({node_h:"%",node_spacing:"%",node_opacity:".2",flow_curvature:"|",flow_opacity:".2",labels_highlight:".2",labelposition_breakpoint:"never"}[t]){case"|":if(r<=.1){a.textContent="0.00";break}case".2":a.textContent=d3.format(".2f")(r);break;case"%":a.textContent=`${r}%`;break;case"never":a.textContent=Number(r)===s.labelNeverBreakpoint?"∅":r;break;default:a.textContent=r}return null},s.revealVal=t=>{s.updateOutput(t);const r=x(t).classList;return r.remove("fade-init","fade-out"),r.add("fade-in"),null},s.fadeVal=t=>(x(t).classList.replace("fade-in","fade-out"),null);function M(t){return!Number.isNaN(t-parseFloat(t))}function U(t,r,a){return M(t)?Math.min(Math.max(t,r),a):r}function fe(t){return document.forms.skm_form.elements[t]}s.checkRadio=t=>{g(t).checked=!0},s.rememberedMoves=new Map,s.resetMovesAndRender=()=>(s.rememberedMoves.clear(),s.process_sankey(),null);function he(){g("reset_all_moved_nodes").disabled=!s.rememberedMoves.size}function Se(t){const r=d3.rgb(t),a=(r.r*299+r.g*587+r.b*114)/1e3,i=Math.floor(a>164?.75*a-64:.3*a+192);return d3.rgb(i,i,i)}function ge(t){return t.replaceAll("→","&#8594;").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;").replaceAll(`
`,"<br />")}function f(t){return Number(t.toFixed(5)).toString()}function _e(t,r){return r.group===","?t:t.replaceAll(",","!").replaceAll(".",r.decimal).replaceAll("!",r.group)}function ie(t,r){const a=_e(d3.format(`,.${r.decimalPlaces}${r.trimString}f`)(t),r.marks);return`${r.prefix}${a}${r.suffix}`}function we(t){const r=g("sankey_svg");r.setAttribute("height",t.size_h),r.setAttribute("width",t.size_w),r.setAttribute("class",`svg_background_${t.bg_transparent?"transparent":"default"}`),r.textContent=""}const Ae=d3.timeFormat("%Y%m%d_%H%M%S");s.fileTimestamp=()=>Ae(new Date),s.humanTimestamp=()=>new Date().toLocaleString();async function ye(t){const r=g("chart"),a={w:r.clientWidth,h:r.clientHeight},i=U(t,1,6),l={w:a.w*i,h:a.h*i},p={x:(l.w-a.w)/(2*i),y:(l.h-a.h)/(2*i)},_=g("png_preview"),w=_.getContext("2d"),h=new XMLSerializer().serializeToString(g("sankey_svg"));return _.width=l.w,_.height=l.h,await(await canvg.Canvg.fromString(w,h,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,scaleWidth:l.w,scaleHeight:l.h,offsetX:p.x,offsetY:p.y})).render(),[l,_.toDataURL("image/png")]}function ve(t,r){const a=document.createElement("a");a.style.display="none",a.href=t,a.download=r,document.body.append(a),a.click(),a.remove()}s.saveDiagramAsPNG=async t=>{const[r,a]=await ye(t);ve(a,`sankeymatic_${s.fileTimestamp()}_${r.w}x${r.h}.png`)};function se(t,r){const a=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(a);ve(i,r),URL.revokeObjectURL(i)}s.saveDiagramAsSVG=()=>{const t=g("sankey_svg").outerHTML.replace(' id="sankey_svg"',"").replace(/ class="svg_background_[a-z]+"/,"").replace(/>/,`>\r
<title>Your Diagram Title</title>\r
<!-- Generated with SankeyMATIC: ${s.humanTimestamp()} -->\r
`).replace(/><(g|\/g|path|text|rect)/g,`>\r
<$1`);se(t,`sankeymatic_${s.fileTimestamp()}.svg`)};function be(t){const r=t.source.x+t.source.dx,a=t.target.x,i=t.source.y+t.sy,l=t.target.y+t.ty+t.dy;return t.renderAs="flat",`M${f(r)} ${f(i)}v${f(t.dy)}L${f(a)} ${f(l)}v${f(-t.dy)}z`}function Me(t){return r=>{const a=r.source.y+r.sy+r.dy/2,i=r.target.y+r.ty+r.dy/2,l=r.source.x+r.source.dx,p=r.target.x;if(Math.abs(a-i)<2||Math.abs(p-l)<12)return be(r);r.renderAs="curved";const _=d3.interpolateNumber(l,p),w=_(t),h=_(1-t);return`M${f(l)} ${f(a)}C${f(w)} ${f(a)} ${f(h)} ${f(i)} ${f(p)} ${f(i)}`}}function H(t,r,a){const[i,l,p]=t;if(i==="yn"&&reYesNo.test(r))return[!0,reYes.test(r)];if(["radio","list"].includes(i)&&p.includes(r))return[!0,r];if(i==="color"){let h;if(reRGBColor.test(r))h=d3.rgb(r);else if(reBareColor.test(r))h=d3.rgb(`#${r}`);else{const $=d3.color(r);$&&(h=$)}if(h)return[!0,h.formatHex()]}function _(h,[$,A]){return h>=$&&(A===void 0||h<=A)}if(i==="text"){const h=r.replaceAll("''","'");if(_(h.length,p))return[!0,h]}const w=Number(r);if(i==="decimal"&&reDecimal.test(r)&&_(w,[0,1]))return[!0,w];if(["whole","contained","breakpoint"].includes(i)&&reWholeNumber.test(r)){let[h,$]=[0];switch(i){case"whole":[h,$]=p;break;case"contained":$=a[p[1]];break;case"breakpoint":$=l;break}if(_(w,[h,$]))return[!0,w]}return[!1]}function W(t,r,a){switch(r){case"radio":fe(t).value=a;break;case"yn":g(t).checked=a;break;default:g(t).value=a}}function oe(t,r){switch(r){case"radio":return fe(t).value;case"color":return g(t).value.toLowerCase();case"yn":return g(t)?.checked?"Y":"N";case"list":case"text":return g(t).value;default:return Number(g(t).value)}}function Re(t,r){switch(r){case"whole":case"decimal":case"contained":case"breakpoint":return Number(t);case"yn":return reYes.test(t);default:return t}}function xe(t){return`&quot;<strong>${ge(t)}</strong>&quot;`}const O={areas:new Map([["issue",{id:"issue_messages",class:"errormessage"}],["difference",{id:"imbalance_messages",class:"differencemessage"}],["total",{id:"totals_area",class:""}],["info",{id:"info_messages",class:"okmessage"}]]),add:(t,r="info")=>{const a=O.areas.get(r)||O.areas.get("info"),i=document.createElement("div");i.innerHTML=t,a.class.length&&i.classList.add(a.class),g(a.id).append(i)},resetAll:()=>{Array.from(O.areas.values()).map(t=>t.id).forEach(t=>{g(t).replaceChildren()})}};s.hideReplaceGraphWarning=()=>(g("replace_graph_warning").style.display="none",null),s.replaceGraphConfirmed=()=>{const t=N("demo_graph_chosen"),r=sampleDiagramRecipes.get(t);Object.entries(r.settings).forEach(([l,p])=>{const _=skmSettings.get(l),[w,h]=H(_,p,{});w&&W(l,_[0],h)});const a="input_options";g(a).style.display==="none"&&s.togglePanel(a);const i=g(userInputsField);return i.focus(),i.select(),i.setRangeText(r.flows,0,i.selectionEnd,"start"),i.blur(),s.hideReplaceGraphWarning(),s.resetMovesAndRender(),null},s.replaceGraph=t=>{const r=sampleDiagramRecipes.get(t);if(!r)return O.add(`Requested sample diagram ${xe(t)} not found.`,"issue"),null;g("demo_graph_chosen").value=t;const a=N(userInputsField);return Array.from(sampleDiagramRecipes.values()).some(l=>l.flows===a)||a===""?s.replaceGraphConfirmed():(g("replace_graph_warning").style.display="",g("replace_graph_yes").textContent=`はい '${r.name}'と置き換えてください`),null};const ke=new Map([["a",{colorset:d3.schemeCategory10,nickname:"Categories",d3Name:"Category10"}],["b",{colorset:d3.schemeTableau10,nickname:"Tableau10",d3Name:"Tableau10"}],["c",{colorset:d3.schemeDark2,nickname:"Dark",d3Name:"Dark2"}],["d",{colorset:d3.schemeSet3,nickname:"Varied",d3Name:"Set3"}]]);function le(t){return ke.get(t.toLowerCase())||{colorset:[],nickname:"Invalid Theme",d3Name:"?"}}function $e(t,r){const a=U(r,0,t.length);return t.slice(a).concat(t.slice(0,a))}function de(t){return`themeoffset_${t}`}s.nudgeColorTheme=(t,r)=>{const a=g(de(t)),i=a===null?0:a.value,l=le(t).colorset.length,p=(l+ +i+ +r)%l;return a.value=p,g(`theme_${t}_radio`).checked=!0,s.process_sankey(),null};function Ne(t,r,a,i){function l(e){return ie(e,i)}const p=d3.select("#svg_scratch").attr("height",a.size_h).attr("width",a.size_w).attr("text-anchor","middle").attr("opacity","0").attr("font-family",a.labels_fontface).attr("font-size",`${a.labelname_size}px`).attr("font-weight",a.labelname_weight);p.selectAll("*").remove();function _(e,o){const u=`bb_${o}`,d=p.append("text").attr("id",u).attr("x",a.size_w/2).attr("y",a.size_h/2).text(e),v=d.node().getBBox();return{w:v.width,h:v.height}}function w(){function e(){return navigator&&/firefox/i.test(navigator.userAgent||navigator.vendor||"")}const o=_("m","em"),u=o.h,d=o.w,v=_("x","ex").w,R=e()?"firefox":"*",S=fontMetrics[R][a.labels_fontface]||fontMetrics[R]["*"],L={dy:S.dy*u,top:S.top*v,bot:S.bot*v,inner:S.inner*d,outer:S.outer*d};return L.lblMarginAfter=a.node_border/2+S.marginRight*L.inner,L.lblMarginBefore=a.node_border/2+(S.marginRight+S.marginAdjLeft)*L.inner,L}const h=w(),$=d3.sankey().nodes(t).flows(r).rightJustifyEndpoints(a.layout_justifyends).leftJustifyOrigins(a.layout_justifyorigins).setup();let A=$.stages();const C=A.length+1;if(C!==s.labelNeverBreakpoint){const e=g("labelposition_breakpoint");e.setAttribute("max",C),(a.labelposition_breakpoint>C||a.labelposition_breakpoint===s.labelNeverBreakpoint)&&(e.value=C,a.labelposition_breakpoint=C),s.labelNeverBreakpoint=C}function T(e){return!e.isAShadow||a.internal_revealshadows}a.labelname_appears&&t.filter(T).filter(e=>!e.hideLabel).forEach(e=>{e.labelText=a.labelvalue_appears?`${e.name}: ${l(e.value)}`:e.name;const o=a.labelposition_first==="before"?e.stage<a.labelposition_breakpoint-1:e.stage>=a.labelposition_breakpoint-1;e.label={dom_id:`label${e.index}`,anchor:o?"end":"start"}});function G(e,o){let u=0;return e.filter(d=>d.labelText).forEach(d=>{const v=_(d.labelText,d.dom_id).w+(o?h.lblMarginBefore:h.lblMarginAfter)+h.outer;u=Math.max(u,v)}),u}function K(){const e=a.size_w-a.margin_l-a.margin_r,o=a.size_h-a.margin_t-a.margin_b,u=A.length-1,d=A[0].filter(me=>me.label?.anchor==="end"),v=A[u].filter(me=>me.label?.anchor==="start"),R=d.length>0?G(A[0],!0):a.node_border/2,S=v.length>0?G(A[u],!1):a.node_border/2,L=e-R-S,pe=A.length*a.node_w+u*(a.node_border+5),Te=Math.max(L,pe),Le=R+S>0?R/(R+S):.5,Oe=L<pe?(L-pe)*Le:0;return{w:Te,h:o,final_margin_l:a.margin_l+R+Oe}}const k=K();$.size({w:k.w,h:k.h}).nodeWidth(a.node_w).nodeHeightFactor(a.node_h/100).nodeSpacingFactor(a.node_spacing/100).autoLayout(a.layout_order==="automatic").attachIncompletesTo(a.layout_attachincompletesto).layout(a.internal_iterations),A=$.stages();const V=a.node_theme==="none"?[a.node_color]:$e(le(a.node_theme).colorset,a[de(a.node_theme)]),Z=d3.scaleOrdinal(V),z=a.flow_curvature<=.1,j=z?be:Me(a.flow_curvature),Q=a.bg_color.toUpperCase()<"#888",b=a.labels_color.toUpperCase()<"#AAA",F=highlightStyles[b?"dark":"light"];F.orig.fill_opacity=Number(a.labels_highlight),F.hover.fill_opacity=.666+Number(a.labels_highlight)/3;function ee(){return(A.length-1)/2}t.filter(T).forEach(e=>{if(e.dom_id=`r${e.index}`,e.css_class=`for_${e.dom_id}`,e.tooltip=`${e.name}:
${l(e.value)}`,e.opacity=e.opacity||a.node_opacity,typeof e.color>"u"||e.color===""){const o=(e.name.match(/^\s*(\S+)/)||[null,"name-is-blank"])[1];e.color=e.isAShadow?colorGray60:Z(o)}if(e.border_color=Q?d3.rgb(e.color).brighter(2):d3.rgb(e.color).darker(2),a.labelname_appears&&!e.hideLabel){const o=e.label.anchor==="end";e.label.x=e.x+(o?-h.lblMarginBefore:e.dx+h.lblMarginAfter),e.label.y=e.y+e.dy/2,e.label.dy=h.dy,F.orig.fill_opacity>0&&(e.label.bg={dom_id:`${e.label.dom_id}_bg`,offset:{x:o?-h.outer:-h.inner,y:-h.top,w:h.inner+h.outer,h:h.top+h.bot},...F.orig})}}),r.filter(T).forEach(e=>{if(e.dom_id=`flow${e.index}`,e.tooltip=`${e.source.name} → ${e.target.name}: ${l(e.value)}`,e.opacity=e.opacity||a.flow_opacity,e.opacity_on_hover=.5+Number(e.opacity)/2,e.color==="")if(e.isAShadow)e.color=colorGray60;else if(e.source.paint[AFTER])e.color=e.source.color;else if(e.target.paint[BEFORE])e.color=e.target.color;else{const o=(e.source.stage+e.target.stage)/2;switch(a.flow_inheritfrom){case"source":e.color=e.source.color;break;case"target":e.color=e.target.color;break;case"outside-in":e.color=o<=ee()?e.source.color:e.target.color;break;case"none":e.color=a.flow_color}}e.fill={flat:e.color,curved:"none"},e.stroke_width={flat:.5,curved:Math.max(1,e.dy)}}),we(a);const te=d3.select("#sankey_svg");a.bg_transparent||te.append("rect").attr("height",a.size_h).attr("width",a.size_w).attr("fill",a.bg_color);const P=te.append("g").attr("transform",`translate(${k.final_margin_l},${a.margin_t})`);function D(e,o,u){d3.select(`#${e.dom_id}`).attr("opacity",o),[e.source,e.target].filter(d=>d.label?.bg).forEach(d=>{d3.select(`#${d.label.bg.dom_id}`).attr("fill",u.fill).attr("fill-opacity",f(u.fill_opacity)).attr("stroke",u.stroke).attr("stroke-width",f(u.stroke_width)).attr("stroke-opacity",f(u.stroke_opacity))})}function I(e,o){o.hovering=!0,D(o,o.opacity_on_hover,F.hover)}function ae(e,o){D(o,o.opacity,F.orig),o.hovering=!1}const re=P.append("g").attr("id","sankey_flows").selectAll().data(r.filter(T)).enter().append("path").attr("id",e=>e.dom_id).attr("d",j).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>f(e.stroke_width[e.renderAs])).attr("stroke",e=>e.color).attr("opacity",e=>e.opacity).on("mouseover",I).on("mouseout",ae).sort((e,o)=>e.isAShadow-o.isAShadow||o.dy-e.dy);re.append("title").text(e=>e.tooltip);function J(e){return e.every(o=>o===0)}function E(e){const o=t[e],u=o.move[0]*(a.layout_reversegraph?-1:1),d=k.w-o.dx,v=k.h-o.dy;o.x=Math.max(0,Math.min(d,o.origPos.x+d*u)),o.y=Math.max(0,Math.min(v,o.origPos.y+v*o.move[1])),d3.selectAll(`#sankey_svg .${o.css_class}`).attr("transform",J(o.move)?null:`translate(${f(o.x-o.origPos.x)},${f(o.y-o.origPos.y)})`)}function Y(e){e.lastPos={x:e.x,y:e.y}}function q(e){Y(e),J(e.move)?s.rememberedMoves.delete(e.name):s.rememberedMoves.set(e.name,e.move),he()}function B(){$.relayout(),re.attr("d",j).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>f(e.stroke_width[e.renderAs]))}function ce(e,o){const u=Se(a.bg_color);let d=P.select("#helper_layer");if(d.nodes.length||(d=P.insert("g","#sankey_nodes").attr("id","helper_layer").attr("fill",u).attr("fill-opacity",.5).attr("stroke","none")),d.append("path").attr("id","helper_lines").attr("d",`M0 ${f(o.lastPos.y)} h${f(k.w)} m0 ${f(o.dy)} H0M${f(o.lastPos.x)} 0 v${f(k.h)} m${f(o.dx)} 0 V0`).attr("stroke",u).attr("stroke-width",1).attr("stroke-dasharray","1 3").attr("stroke-opacity",.7),d.append("rect").attr("id","helper_original_rect").attr("x",f(o.origPos.x)).attr("y",f(o.origPos.y)).attr("height",f(o.dy)).attr("width",f(o.dx)).attr("fill",o.color).attr("fill-opacity",.3),!(e.sourceEvent&&e.sourceEvent.shiftKey)){const v=d.append("g").attr("id","helper_shift_hints").attr("font-size","14px").attr("font-weight","400");(k.h>350?[.05,.95]:[.4]).forEach(S=>{v.append("text").attr("text-anchor","middle").attr("x",k.w/2).attr("y",k.h*S).text("Hold down Shift to move in only one direction")})}return null}function ue(e,o){let u=e.x,d=e.y;const v=g("layout_reversegraph").checked;if(e.sourceEvent&&e.sourceEvent.shiftKey){Math.abs(u-o.lastPos.x)>Math.abs(d-o.lastPos.y)?d=o.lastPos.y:u=o.lastPos.x;const R=P.select("#helper_shift_hints");R.nodes&&R.remove()}return o.move=[(v?-1:1)*((u-o.origPos.x)/(k.w-o.dx)),k.h===o.dy?0:(d-o.origPos.y)/(k.h-o.dy)],E(o.index),B(),null}function n(e,o){const u=P.select("#helper_layer");return u.nodes&&u.remove(),q(o),r.filter(d=>d.hovering).forEach(d=>{ae(null,d)}),B(),null}function c(e,o){return o.move=[0,0],E(o.index),q(o),B(),null}const m=P.append("g").attr("id","sankey_nodes").selectAll(".node").data(t.filter(T)).enter().append("g").attr("class","node").call(d3.drag().on("start",ce).on("drag",ue).on("end",n)).on("dblclick",c);a.node_border&&m.append("rect").attr("id",e=>`${e.dom_id}_border`).attr("class",e=>e.css_class).attr("x",e=>f(e.x)).attr("y",e=>f(e.y)).attr("height",e=>f(e.dy)).attr("width",e=>f(e.dx)).attr("stroke",e=>e.border_color).attr("stroke-width",a.node_border).attr("fill","none"),m.append("rect").attr("id",e=>e.dom_id).attr("class",e=>e.css_class).attr("x",e=>f(e.x)).attr("y",e=>f(e.y)).attr("height",e=>f(e.dy)).attr("width",e=>f(e.dx)).attr("fill",e=>e.color).attr("fill-opacity",e=>e.opacity).append("title").text(e=>e.tooltip);const y=P.append("g").attr("id","sankey_labels").attr("font-family",a.labels_fontface).attr("font-size",`${a.labelname_size}px`).attr("font-weight",a.labelname_weight).attr("fill",a.labels_color);if(a.labelname_appears&&(y.selectAll().data(t.filter(T)).enter().filter(e=>!e.hideLabel).append("text").attr("id",e=>e.label.dom_id).attr("class",e=>e.css_class).attr("text-anchor",e=>e.label.anchor).attr("x",e=>f(e.label.x)).attr("y",e=>f(e.label.y)).attr("dy",e=>e.label.dy).text(e=>e.labelText),t.filter(T).filter(e=>e.label?.bg).forEach(e=>{const o=`#${e.label.dom_id}`,u=y.select(o).node().getBBox(),d=e.label.bg;y.insert("rect",o).attr("id",d.dom_id).attr("class",e.css_class).attr("x",f(u.x+d.offset.x)).attr("y",f(u.y+d.offset.y)).attr("width",f(u.width+d.offset.w)).attr("height",f(u.height+d.offset.h)).attr("rx",f(a.labelname_size/4)).attr("fill",d.fill).attr("fill-opacity",f(d.fill_opacity)).attr("stroke",d.stroke).attr("stroke-width",f(d.stroke_width)).attr("stroke-opacity",f(d.stroke_opacity))})),s.rememberedMoves.size){const e=new Set(s.rememberedMoves.keys());t.filter(T).filter(o=>e.has(o.name)).forEach(o=>{o.move=s.rememberedMoves.get(o.name),E(o.index),Y(o),e.delete(o.name)}),e.forEach(o=>{s.rememberedMoves.delete(o)}),B()}}function Ee(){const t=[];s.rememberedMoves.size&&(t.push(movesMarker,""),s.rememberedMoves.forEach((l,p)=>{t.push(`move ${p} ${f(l[0])}, ${f(l[1])}`)}),t.push(""));let r="";function a(l){const p=r.length;return(p&&l.startsWith(`${r}_`)?`  ${l.substring(p+1)}`:l).replaceAll("_"," ")}const i=new Map([["list",l=>`'${l}'`],["text",l=>`'${l.replaceAll("'","''")}'`]]);return t.push(settingsMarker,""),skmSettings.forEach((l,p)=>{if(p.startsWith("internal_"))return;const _=l[0],w=oe(p,_),h=i.has(_)?i.get(_)(w):w;t.push(`${a(p)} ${h}`),r=p.split("_")[0]}),t.join(`
`)}function ne(t){return t.filter(r=>!(r.startsWith(sourceHeaderPrefix)||r.startsWith(settingsAppliedPrefix)||[settingsMarker,userDataMarker,sourceURLLine,movesMarker].includes(r))).join(`
`).replace(/^\n+/,"").replace(/\n+$/,"")}s.saveDiagramToFile=()=>{const t=ne(N(userInputsField).split(`
`)),r=`${sourceHeaderPrefix} Saved: ${s.humanTimestamp()}
${sourceURLLine}

${userDataMarker}

${t}

${Ee()}
`;se(r,`sankeymatic_${s.fileTimestamp()}_source.txt`)},s.saveDiagramAsJSON=()=>{const t={};skmSettings.forEach((l,p)=>{if(!p.startsWith("internal_")){const _=l[0];t[p]=oe(p,_)}});const r=ne(N(userInputsField).split(`
`)),a={};s.rememberedMoves.size&&s.rememberedMoves.forEach((l,p)=>{a[p]=l});const i={credits:"Made with SankeyMATIC",timestamp:s.humanTimestamp(),flows:r,settings:t,moves:a};se(JSON.stringify(i,null,2),`sankeymatic_${s.fileTimestamp()}.json`)},s.process_sankey=(t=null)=>{let[r,a,i]=[0,0,0];const l=new Map;function p(){const n=(c,m,y)=>`<span style="background-color: ${c};" class="color_sample_${m}" title="${c} from d3 color scheme ${y}">&nbsp;</span>`;for(const c of ke.keys()){const m=le(c),y=N(de(c)),e=$e(m.colorset,y),o=e.map(u=>n(u,e.length,m.d3Name)).join("");g(`theme_${c}_guide`).innerHTML=o,g(`theme_${c}_label`).textContent=m.nickname}}function _(n){const c=n.match(/^-(.*)-$/),m=c!==null;return{trueName:m?c[1]:n,hideLabel:m}}function w(n,c){const m=_(n);if(l.has(m.trueName)){const y=l.get(m.trueName);y.sourceRow>c&&(y.sourceRow=c),y.hideLabel||=m.hideLabel}else l.set(m.trueName,{name:m.trueName,hideLabel:m.hideLabel,sourceRow:c,paintInputs:[]})}function h(n){return l.get(_(n).trueName)}function $(n){w(n.name,n.sourceRow),delete n.sourceRow,reBareColor.test(n.color)&&(n.color=`#${n.color}`);const c=h(n.name);delete n.name,Object.entries(n).forEach(([m,y])=>{typeof y<"u"&&y!==null&&y!==""&&(c[m]=y)})}O.resetAll();const A=N(userInputsField).split(`
`),C=A.map(n=>n.trim().replace(/^\u200B+/,"").replace(/\u200B+$/,"").trim()),T=[],G=new Set,K=new Set;function k(n,c){T.push({value:n,message:c})}let V="";C.forEach((n,c)=>{const m=n.match(reMoveLine);if(m!==null){G.add(c);const[e,o,u]=m.slice(-3);s.rememberedMoves.set(e,[Number(o),Number(u)]),K.add(c);return}const y=n.match(reSettingsValue)??n.match(reSettingsText);if(y!==null){G.add(c);let e=y[1],o=e.replace(/\s+/g,"_");"width height left right top bottom".split(" ").filter(d=>o.endsWith(d)).forEach(d=>{o=o.replace(d,d[0])}),!skmSettings.has(o)&&!/_/.test(o)&&V.length&&(o=`${V}_${o}`,e=`${V} ${e}`),V=o.split("_")[0];const u=skmSettings.get(o);if(u){const d=y[2],v=u[0],R=v==="contained"?{w:N("size_w"),h:N("size_h")}:{},[S,L]=H(u,d,R);if(S){W(o,v,L),K.add(c);return}k(d,`Invalid value for <strong>${e}<strong>`)}else k(e,"Not a valid setting name")}});const Z=[],z=[],j=[];C.filter((n,c)=>!G.has(c)).forEach((n,c)=>{if(n===""||reCommentLine.test(n))return;let m=n.match(reNodeLine);if(m!==null){$({name:m[1].trim(),color:m[2],opacity:m[3],paintInputs:[m[4],m[5]],sourceRow:c});return}if(m=n.match(reFlowLine),m!==null){const y=m[2].replace(/\s/g,"");if(!M(y)){k(n,"The Amount is not a valid decimal number");return}if(y<=0){k(n,"Amounts must be greater than 0");return}Z.push({source:m[1].trim(),target:m[3].trim(),amount:y,sourceRow:c}),r=Math.max(r,(y.split(".")[1]||"").length);return}k(n,"Does not match the format of a Flow or Node or Setting")}),T.forEach(n=>{O.add(`${n.message}: ${xe(n.value)}`,"issue")});const Q=g("layout_reversegraph").checked;Z.forEach(n=>{let[c,m]=["",""];const y=n.target.match(reFlowTargetWithSuffix);if(y!==null){const[,o,u]=y,d=u.match(reColorPlusOpacity);d!==null&&(n.target=o,d[1]&&(c=`#${d[1]}`),d[2]&&(m=d[2]))}w(n.source,n.sourceRow),w(n.target,n.sourceRow+.5);const e={index:j.length,source:h(n.source),target:h(n.target),value:n.amount,color:c,opacity:m,hovering:!1,sourceRow:n.sourceRow};Q&&([e.source,e.target]=[e.target,e.source]),j.push(e)}),Array.from(l.values()).sort((n,c)=>n.sourceRow-c.sourceRow).forEach(n=>{const c=n.paintInputs.some(y=>y==="<<"),m=n.paintInputs.some(y=>y===">>");n.paint={[BEFORE]:Q?m:c,[AFTER]:Q?c:m},delete n.paintInputs,n.index=z.length,z.push(n)});const b={};skmSettings.forEach((n,c)=>{const[m,y]=n,e=oe(c,m),o=m==="contained"?{w:b.size_w,h:b.size_h}:{},[u,d]=H(n,e,o);if(u){b[c]=d;return}const v=Re(y,m);b[c]=v,W(c,m,v)});const F=g("chart");F.style.height=`${b.size_h}px`,F.style.width=`${b.size_w}px`,[1,2,4,6].forEach(n=>{g(`save_as_png_${n}x`).title=`PNG image file: ${b.size_w*n} x ${b.size_h*n}`});const ee=A.map((n,c)=>K.has(c)?`${settingsAppliedPrefix}${n}`:n);if(ee[0].startsWith(sourceHeaderPrefix)?(g(userInputsField).value=ne(ee),t&&O.add(`Imported <strong>${t}</strong>.`)):g(userInputsField).value=ee.join(`
`),!Z.length)return O.add('Enter a list of Flows &mdash; one per line. See the <a href="/manual/" target="_blank">Manual</a> for more help.'),we(b),null;const[te,P]=b.value_format,D={marks:{group:te==="X"?"":te,decimal:P},decimalPlaces:r,trimString:b.labelvalue_fullprecision?"":"~",prefix:b.value_prefix,suffix:b.value_suffix};if(b.layout_reversegraph)switch(b.flow_inheritfrom){case"source":b.flow_inheritfrom="target";break;case"target":b.flow_inheritfrom="source";break}Ne(z,j,b,D);function I(n){return ie(n,D)}function ae(n,c){const m=I(n.total[c]),y=n.flows[c].filter(u=>!u.isAShadow),e=y.length;if(e===1)return m;const o=y.map(u=>u.value).sort((u,d)=>d-u).map(u=>I(u)).join(" + ");return`<dfn title="${m} from ${e} Flows: ${o}">${m}</dfn>`}const re=10**(-r-1),J=[],E={[IN]:0,[OUT]:0};z.forEach((n,c)=>{if(n.total[IN]>0&&n.total[OUT]>0){const m=n.total[IN]-n.total[OUT];Math.abs(m)>re&&J.push({name:n.name,total:{[IN]:ae(n,IN),[OUT]:ae(n,OUT)},difference:I(m)})}else E[IN]+=n.total[IN],E[OUT]+=n.total[OUT];n.value>i&&(a=c,i=n.value)});const Y=!J.length;if(["meta_listimbalances","layout_attachto_leading","layout_attachto_trailing","layout_attachto_nearest"].forEach(n=>{g(n).disabled=Y}),g("imbalances_area").setAttribute("aria-disabled",Y),!Y&&b.meta_listimbalances){const n=["<tr><td></td><th>Total In</th><th>Total Out</th><th>Difference</th></tr>"];J.forEach(c=>{n.push(`<tr><td class="nodename">${ge(c.name)}</td><td>${c.total[IN]}</td><td>${c.total[OUT]}</td><td>${c.difference}</td></tr>`)}),O.add(`<table class="center_basic">${n.join(`
`)}</table>`,"difference")}let q=`<strong>${z.length} ノード</strong> 間に <strong>${j.length} フロー</strong>  `;if(Math.abs(E[IN]-E[OUT])>re){const n=E[IN]>E[OUT]?"&gt;":"&lt;";q+=`Total Inputs: <strong>${I(E[IN])}</strong> ${n} Total Outputs: <strong>${I(E[OUT])}</strong>`}else q+=`トータル・インプット = トータル・アウトプット = <strong>${I(E[IN])}</strong> &#9989;`;O.add(q,"total"),p();const B=parseFloat(g(`r${a}`).getAttributeNS(null,"height")),ce=_e(d3.format(",.2~f")(B),D.marks),ue=ie(i/B,{...D,decimalPlaces:4});return g("scale_figures").innerHTML=`<strong>${ue}</strong> per pixel (${I(i)}/${ce}px)`,he(),null},s.process_sankey(),s.loadDiagramFile=async()=>{const t=g("load_diagram_from_file").files;if(t.length===0)return;const r=await t[0].text(),a=t[0].name;if(r.trim().startsWith("{"))try{const i=JSON.parse(r);typeof i.flows=="string"&&(g(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,p])=>{const _=skmSettings.get(l);if(_){const[w,h]=H(_,p,{});w&&W(l,_[0],h)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,p])=>{s.rememberedMoves.set(l,p)})),s.process_sankey(a);return}catch(i){console.warn("File looked like JSON but failed to parse:",i)}g(userInputsField).value=r,s.process_sankey(a)},s.saveCloudProjectUI=async()=>{const t={};skmSettings.forEach((_,w)=>{if(!w.startsWith("internal_")){const h=_[0];t[w]=oe(w,h)}});const r=ne(N(userInputsField).split(`
`)),a={};s.rememberedMoves.forEach((_,w)=>{a[w]=_});const i={metadata:{saved_at:new Date().toISOString(),generator:"SankeyMATIC",version:"1.0"},settings:t,flows:r,moves:a},[l,p]=await ye(1);window.CloudUI.openSaveModal(i,p)},s.loadCloudProjectUI=()=>{window.CloudUI.openLoadModal(t=>{s.loadProjectData(t)})},s.loadProjectData=t=>{typeof t.flows=="string"&&(g(userInputsField).value=t.flows),t.settings&&typeof t.settings=="object"&&Object.entries(t.settings).forEach(([r,a])=>{const i=skmSettings.get(r);if(i){const[l,p]=H(i,a,{});l&&W(r,i[0],p)}}),t.moves&&typeof t.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(t.moves).forEach(([r,a])=>{s.rememberedMoves.set(r,a)})),s.process_sankey()},window.addEventListener("dataviz-save-trigger",()=>{s.saveDiagramAsJSON()}),window.addEventListener("dataviz-load-trigger",async t=>{if(t.detail&&t.detail.file){const r=t.detail.file,a=await r.text();if(a.trim().startsWith("{"))try{const i=JSON.parse(a);typeof i.flows=="string"&&(g(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,p])=>{const _=skmSettings.get(l);if(_){const[w,h]=H(_,p,{});w&&W(l,_[0],h)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,p])=>{s.rememberedMoves.set(l,p)})),s.process_sankey(r.name);return}catch(i){console.warn("JSON parse error from header load:",i)}g(userInputsField).value=a,s.process_sankey(r.name)}}),window.addEventListener("load",()=>{const r=new URLSearchParams(window.location.search).get("project_id")||window.SKM_PROJECT_ID;if(r){console.log("Found project_id:",r);let a=0;const i=setInterval(async()=>{if(a++,a>50){clearInterval(i),console.error("Timeout waiting for CloudApi/Supabase");return}if(window.CloudApi&&window.datavizSupabase){clearInterval(i);const{data:{session:l}}=await window.datavizSupabase.auth.getSession();if(l){const p=document.createElement("div");p.textContent="Loading Project...",p.style.cssText="position:fixed;top:10px;right:10px;background:#036;color:#fff;padding:15px;border-radius:5px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.3);",document.body.appendChild(p);try{const _=await window.CloudApi.loadProject(r);console.log("Project loaded:",_);let w=_;if(w.data&&!w.flows&&!w.settings&&(w=w.data),typeof w=="string"&&w.trim().startsWith("{"))try{w=JSON.parse(w)}catch{}s.loadProjectData(w);const h=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({path:h},"",h)}catch(_){console.error("Auto-load failed",_),alert("プロジェクトの読み込みに失敗しました: "+_.message)}finally{p.remove()}}else console.warn("No session found for auto-load")}},500)}})})(window==="undefined"?global:window);
