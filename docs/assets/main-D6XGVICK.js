(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const k of document.querySelectorAll('link[rel="modulepreload"]'))N(k);new MutationObserver(k=>{for(const M of k)if(M.type==="childList")for(const U of M.addedNodes)U.tagName==="LINK"&&U.rel==="modulepreload"&&N(U)}).observe(document,{childList:!0,subtree:!0});function g(k){const M={};return k.integrity&&(M.integrity=k.integrity),k.referrerPolicy&&(M.referrerPolicy=k.referrerPolicy),k.crossOrigin==="use-credentials"?M.credentials="include":k.crossOrigin==="anonymous"?M.credentials="omit":M.credentials="same-origin",M}function N(k){if(k.ep)return;k.ep=!0;const M=g(k);fetch(k.href,M)}})();(function(){if(window.location.search){const X=new URLSearchParams(window.location.search).get("project_id");X&&(window.SKM_PROJECT_ID=X,console.log("Rescued project_id:",X))}})();window.skmSettings=new Map([["size_w",["whole",600,[40]]],["size_h",["whole",600,[40]]],["margin_l",["contained",12,[0,"w"]]],["margin_r",["contained",12,[0,"w"]]],["margin_t",["contained",18,[0,"h"]]],["margin_b",["contained",20,[0,"h"]]],["bg_color",["color","#ffffff",[]]],["bg_transparent",["yn","n",[]]],["node_w",["contained",9,[0,"w"]]],["node_h",["whole",50,[0,100]]],["node_spacing",["whole",85,[0,100]]],["node_border",["contained",0,[0,"w"]]],["node_theme",["radio","none",["a","b","c","d","none"]]],["node_color",["color","#888888",[]]],["node_opacity",["decimal",1,[]]],["flow_curvature",["decimal",.5,[]]],["flow_inheritfrom",["radio","none",["source","target","outside-in","none"]]],["flow_color",["color","#999999",[]]],["flow_opacity",["decimal",.45,[]]],["layout_order",["radio","automatic",["automatic","exact"]]],["layout_justifyorigins",["yn","n",[]]],["layout_justifyends",["yn","n",[]]],["layout_reversegraph",["yn","n",[]]],["layout_attachincompletesto",["radio","nearest",["leading","nearest","trailing"]]],["labels_color",["color","#000000",[]]],["labels_highlight",["decimal",.55,[]]],["labels_fontface",["radio","sans-serif",["monospace","sans-serif","serif"]]],["labelname_appears",["yn","y",[]]],["labelname_size",["whole",16,[6]]],["labelname_weight",["radio","400",["100","400","700"]]],["labelvalue_appears",["yn","y",[]]],["labelvalue_fullprecision",["yn","y",[]]],["labelposition_first",["radio","before",["before","after"]]],["labelposition_breakpoint",["breakpoint",9999,[2]]],["value_format",["list",",.",[",.",".,"," ."," ,","X.","X,"]]],["value_prefix",["text","",[0,99]]],["value_suffix",["text","",[0,99]]],["themeoffset_a",["whole",9,[0,9]]],["themeoffset_b",["whole",0,[0,9]]],["themeoffset_c",["whole",0,[0,7]]],["themeoffset_d",["whole",0,[0,11]]],["meta_listimbalances",["yn","y",[]]],["internal_iterations",["whole",25,[0,50]]],["internal_revealshadows",["yn","n",[]]]]);window.reWholeNumber=/^\d+$/;window.reDecimal=/^\d(?:.\d+)?$/;window.reCommentLine=/^(?:'|\/\/)/;window.reYesNo=/^(?:y|yes|n|no)/i;window.reYes=/^(?:y|yes)/i;window.reSettingsValue=/^((?:\w+\s*){1,2}) (#?[\w.-]+)$/;window.reSettingsText=/^((?:\w+\s*){1,2}) '(.*)'$/;window.reMoveLine=/^move (.+) (-?\d(?:.\d+)?), (-?\d(?:.\d+)?)$/;window.sourceHeaderPrefix="// SankeyMATIC diagram inputs -";window.sourceURLLine="// https://sankeymatic.com/build/";window.userDataMarker="// === Nodes and Flows ===";window.movesMarker="// === Moved Nodes ===";window.settingsMarker="// === Settings ===";window.settingsAppliedPrefix="// ✓ ";window.reNodeLine=/^:(.+) #([a-f0-9]{0,6})?(\.\d{1,4})?\s*(>>|<<)*\s*(>>|<<)*$/i;window.reFlowLine=/^(.+)\[([\d\s.+-]+)\](.+)$/;window.reFlowTargetWithSuffix=/^(.+)\s+(#\S+)$/;window.reColorPlusOpacity=/^#([a-f0-9]{3,6})?(\.\d{1,4})?$/i;window.reBareColor=/^(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.reRGBColor=/^#(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.colorGray60="#999";window.userInputsField="flows_in";window.IN=13;window.OUT=17;window.BEFORE=19;window.AFTER=23;window.fontMetrics={firefox:{"sans-serif":{dy:.35,top:.55,bot:.25,inner:.35,outer:.35,marginRight:1.4,marginAdjLeft:0},monospace:{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.48,marginAdjLeft:-.08},"*":{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.35,marginAdjLeft:-.05}},"*":{monospace:{dy:.28,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.45,marginAdjLeft:0},"*":{dy:.29,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.35,marginAdjLeft:0}}};window.highlightStyles={dark:{orig:{fill:"#fff",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#ffb",stroke:"#440",stroke_width:1,stroke_opacity:.7}},light:{orig:{fill:"#000",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#603",stroke:"#fff",stroke_width:1.7,stroke_opacity:.9}}};window.sampleDiagramRecipes=new Map([["default_budget",{name:"Basic Budget",flows:`// Enter Flows between Nodes, like this:
//         Source [AMOUNT] Target

Wages [1500] Budget
Other [250] Budget

Budget [450] Taxes
Budget [420] Housing
Budget [400] Food
Budget [295] Transportation
Budget [25] Savings

// You can set a Node's color, like this:
:Budget #708090
//            ...or a color for a single Flow:
Budget [160] Other Necessities #0F0

// Use the controls below to customize
// your diagram's appearance...`,settings:{size_w:600,node_w:9,node_h:50,node_spacing:85,node_theme:"a",flow_inheritfrom:"outside-in",layout_justifyends:"n",layout_order:"automatic",labelname_size:16,value_prefix:""}}],["election",{name:"Ranked Election",flows:`// Sample Ranked Election diagram

GH - Round 1 [300000] GH - Round 2
EF - Round 1 [220000] EF - Round 2
CD - Round 1 [200000] CD - Round 2
AB - Round 1 [10000] GH - Round 2
AB - Round 1 [25000] EF - Round 2
AB - Round 1 [20000] CD - Round 2

GH - Round 2 [310000] GH - Round 3
EF - Round 2 [245000] EF - Round 3
CD - Round 2 [50000] GH - Round 3
CD - Round 2 [95000] EF - Round 3

// This line sets a custom gray color:
:No further votes #555 <<
AB - Round 1 [20000] No further votes
CD - Round 2 [75000] No further votes`,settings:{size_w:700,node_w:9,node_h:76,node_spacing:85,node_theme:"a",flow_inheritfrom:"source",layout_justifyends:"n",layout_order:"exact",labelname_size:14,value_prefix:""}}],["job_search",{name:"Job Search",flows:`// Sample Job Search diagram:

Applications [4] Interview
Applications [9] Rejected
Applications [4] No Answer

Interview [2] 2nd Interview
Interview [2] No Offer

2nd Interview [2] Offer

Offer [1] Accepted
Offer [1] Declined`,settings:{size_w:700,node_w:5,node_h:50,node_spacing:50,node_theme:"a",flow_inheritfrom:"target",layout_justifyends:"n",layout_order:"automatic",labelname_size:14,value_prefix:""}}],["financial_results",{name:"Financial Results",flows:`Division A [900] Revenue
Division B [750] Revenue
Division C [150] Revenue

Revenue [1000] Gross Profit

Gross Profit [350] Operating Profit
Gross Profit [650] Operating Expenses

Operating Profit [260] Net Profit
Operating Profit [90] Tax

Operating Expenses [640] S G & Admin
Operating Expenses [10] Amortization

Revenue [800] Cost of Sales

// Profit - blue
:Gross Profit #48e <<
:Operating Profit #48e <<
:Net Profit #48e <<

// Expenses - rust
:Operating Expenses #d74 <<
:Tax #d74 <<
:S G & Admin #d74 <<
:Amortization #d74 <<

// Cost - grayish-gold
:Cost of Sales #e6cc91 <<

// main Revenue node: dark grey
:Revenue #444`,settings:{size_w:1e3,node_w:5,node_h:70,node_spacing:70,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"y",layout_order:"automatic",labelname_size:13,value_prefix:"$"}}],["simple_start",{name:"Start Simple",flows:`a [1] b
a [1] c`,settings:{size_w:600,node_w:12,node_h:50,node_spacing:80,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"n",layout_order:"automatic",labelname_size:15,value_prefix:""}}]]);(function(s){function g(t){return document.getElementById(t)}function N(t){return document.getElementById(t).value}s.togglePanel=t=>{const a=g(t),r=a.tagName==="SPAN"?"inline":"",i=a.style.display==="none"?{display:r,suffix:":",action:"–"}:{display:"none",suffix:"...",action:"+"};return a.style.display=i.display,g(`${t}_hint`).textContent=i.suffix,g(`${t}_indicator`).textContent=i.action,null};function k(t){return g(`${t}_val`)}s.labelNeverBreakpoint=9999,s.updateOutput=t=>{const a=N(t),r=k(t);switch({node_h:"%",node_spacing:"%",node_opacity:".2",flow_curvature:"|",flow_opacity:".2",labels_highlight:".2",labelposition_breakpoint:"never"}[t]){case"|":if(a<=.1){r.textContent="0.00";break}case".2":r.textContent=d3.format(".2f")(a);break;case"%":r.textContent=`${a}%`;break;case"never":r.textContent=Number(a)===s.labelNeverBreakpoint?"∅":a;break;default:r.textContent=a}return null},s.revealVal=t=>{s.updateOutput(t);const a=k(t).classList;return a.remove("fade-init","fade-out"),a.add("fade-in"),null},s.fadeVal=t=>(k(t).classList.replace("fade-in","fade-out"),null);function M(t){return!Number.isNaN(t-parseFloat(t))}function U(t,a,r){return M(t)?Math.min(Math.max(t,a),r):a}function fe(t){return document.forms.skm_form.elements[t]}s.checkRadio=t=>{g(t).checked=!0},s.rememberedMoves=new Map,s.resetMovesAndRender=()=>(s.rememberedMoves.clear(),s.process_sankey(),null);function he(){g("reset_all_moved_nodes").disabled=!s.rememberedMoves.size}function Se(t){const a=d3.rgb(t),r=(a.r*299+a.g*587+a.b*114)/1e3,i=Math.floor(r>164?.75*r-64:.3*r+192);return d3.rgb(i,i,i)}function ge(t){return t.replaceAll("→","&#8594;").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;").replaceAll(`
`,"<br />")}function h(t){return Number(t.toFixed(5)).toString()}function _e(t,a){return a.group===","?t:t.replaceAll(",","!").replaceAll(".",a.decimal).replaceAll("!",a.group)}function ie(t,a){const r=_e(d3.format(`,.${a.decimalPlaces}${a.trimString}f`)(t),a.marks);return`${a.prefix}${r}${a.suffix}`}function we(t){const a=g("sankey_svg");a.setAttribute("height",t.size_h),a.setAttribute("width",t.size_w),a.setAttribute("class",`svg_background_${t.bg_transparent?"transparent":"default"}`),a.textContent=""}const Ae=d3.timeFormat("%Y%m%d_%H%M%S");s.fileTimestamp=()=>Ae(new Date),s.humanTimestamp=()=>new Date().toLocaleString();function ye(t){const a=g("chart"),r={w:a.clientWidth,h:a.clientHeight},i=U(t,1,6),l={w:r.w*i,h:r.h*i},c={x:(l.w-r.w)/(2*i),y:(l.h-r.h)/(2*i)},_=g("png_preview"),w=_.getContext("2d"),m=new XMLSerializer().serializeToString(g("sankey_svg"));return _.width=l.w,_.height=l.h,canvg.Canvg.fromString(w,m,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,scaleWidth:l.w,scaleHeight:l.h,offsetX:c.x,offsetY:c.y}).render(),[l,_.toDataURL("image/png")]}function be(t,a){const r=document.createElement("a");r.style.display="none",r.href=t,r.download=a,document.body.append(r),r.click(),r.remove()}s.saveDiagramAsPNG=t=>{const[a,r]=ye(t);be(r,`sankeymatic_${s.fileTimestamp()}_${a.w}x${a.h}.png`)};function se(t,a){const r=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(r);be(i,a),URL.revokeObjectURL(i)}s.saveDiagramAsSVG=()=>{const t=g("sankey_svg").outerHTML.replace(' id="sankey_svg"',"").replace(/ class="svg_background_[a-z]+"/,"").replace(/>/,`>\r
<title>Your Diagram Title</title>\r
<!-- Generated with SankeyMATIC: ${s.humanTimestamp()} -->\r
`).replace(/><(g|\/g|path|text|rect)/g,`>\r
<$1`);se(t,`sankeymatic_${s.fileTimestamp()}.svg`)};function ve(t){const a=t.source.x+t.source.dx,r=t.target.x,i=t.source.y+t.sy,l=t.target.y+t.ty+t.dy;return t.renderAs="flat",`M${h(a)} ${h(i)}v${h(t.dy)}L${h(r)} ${h(l)}v${h(-t.dy)}z`}function Me(t){return a=>{const r=a.source.y+a.sy+a.dy/2,i=a.target.y+a.ty+a.dy/2,l=a.source.x+a.source.dx,c=a.target.x;if(Math.abs(r-i)<2||Math.abs(c-l)<12)return ve(a);a.renderAs="curved";const _=d3.interpolateNumber(l,c),w=_(t),m=_(1-t);return`M${h(l)} ${h(r)}C${h(w)} ${h(r)} ${h(m)} ${h(i)} ${h(c)} ${h(i)}`}}function H(t,a,r){const[i,l,c]=t;if(i==="yn"&&reYesNo.test(a))return[!0,reYes.test(a)];if(["radio","list"].includes(i)&&c.includes(a))return[!0,a];if(i==="color"){let m;if(reRGBColor.test(a))m=d3.rgb(a);else if(reBareColor.test(a))m=d3.rgb(`#${a}`);else{const x=d3.color(a);x&&(m=x)}if(m)return[!0,m.formatHex()]}function _(m,[x,A]){return m>=x&&(A===void 0||m<=A)}if(i==="text"){const m=a.replaceAll("''","'");if(_(m.length,c))return[!0,m]}const w=Number(a);if(i==="decimal"&&reDecimal.test(a)&&_(w,[0,1]))return[!0,w];if(["whole","contained","breakpoint"].includes(i)&&reWholeNumber.test(a)){let[m,x]=[0];switch(i){case"whole":[m,x]=c;break;case"contained":x=r[c[1]];break;case"breakpoint":x=l;break}if(_(w,[m,x]))return[!0,w]}return[!1]}function W(t,a,r){switch(a){case"radio":fe(t).value=r;break;case"yn":g(t).checked=r;break;default:g(t).value=r}}function oe(t,a){switch(a){case"radio":return fe(t).value;case"color":return g(t).value.toLowerCase();case"yn":return g(t)?.checked?"Y":"N";case"list":case"text":return g(t).value;default:return Number(g(t).value)}}function Re(t,a){switch(a){case"whole":case"decimal":case"contained":case"breakpoint":return Number(t);case"yn":return reYes.test(t);default:return t}}function xe(t){return`&quot;<strong>${ge(t)}</strong>&quot;`}const O={areas:new Map([["issue",{id:"issue_messages",class:"errormessage"}],["difference",{id:"imbalance_messages",class:"differencemessage"}],["total",{id:"totals_area",class:""}],["info",{id:"info_messages",class:"okmessage"}]]),add:(t,a="info")=>{const r=O.areas.get(a)||O.areas.get("info"),i=document.createElement("div");i.innerHTML=t,r.class.length&&i.classList.add(r.class),g(r.id).append(i)},resetAll:()=>{Array.from(O.areas.values()).map(t=>t.id).forEach(t=>{g(t).replaceChildren()})}};s.hideReplaceGraphWarning=()=>(g("replace_graph_warning").style.display="none",null),s.replaceGraphConfirmed=()=>{const t=N("demo_graph_chosen"),a=sampleDiagramRecipes.get(t);Object.entries(a.settings).forEach(([l,c])=>{const _=skmSettings.get(l),[w,m]=H(_,c,{});w&&W(l,_[0],m)});const r="input_options";g(r).style.display==="none"&&s.togglePanel(r);const i=g(userInputsField);return i.focus(),i.select(),i.setRangeText(a.flows,0,i.selectionEnd,"start"),i.blur(),s.hideReplaceGraphWarning(),s.resetMovesAndRender(),null},s.replaceGraph=t=>{const a=sampleDiagramRecipes.get(t);if(!a)return O.add(`Requested sample diagram ${xe(t)} not found.`,"issue"),null;g("demo_graph_chosen").value=t;const r=N(userInputsField);return Array.from(sampleDiagramRecipes.values()).some(l=>l.flows===r)||r===""?s.replaceGraphConfirmed():(g("replace_graph_warning").style.display="",g("replace_graph_yes").textContent=`はい '${a.name}'と置き換えてください`),null};const ke=new Map([["a",{colorset:d3.schemeCategory10,nickname:"Categories",d3Name:"Category10"}],["b",{colorset:d3.schemeTableau10,nickname:"Tableau10",d3Name:"Tableau10"}],["c",{colorset:d3.schemeDark2,nickname:"Dark",d3Name:"Dark2"}],["d",{colorset:d3.schemeSet3,nickname:"Varied",d3Name:"Set3"}]]);function le(t){return ke.get(t.toLowerCase())||{colorset:[],nickname:"Invalid Theme",d3Name:"?"}}function $e(t,a){const r=U(a,0,t.length);return t.slice(r).concat(t.slice(0,r))}function de(t){return`themeoffset_${t}`}s.nudgeColorTheme=(t,a)=>{const r=g(de(t)),i=r===null?0:r.value,l=le(t).colorset.length,c=(l+ +i+ +a)%l;return r.value=c,g(`theme_${t}_radio`).checked=!0,s.process_sankey(),null};function Ne(t,a,r,i){function l(e){return ie(e,i)}const c=d3.select("#svg_scratch").attr("height",r.size_h).attr("width",r.size_w).attr("text-anchor","middle").attr("opacity","0").attr("font-family",r.labels_fontface).attr("font-size",`${r.labelname_size}px`).attr("font-weight",r.labelname_weight);c.selectAll("*").remove();function _(e,o){const p=`bb_${o}`,d=c.append("text").attr("id",p).attr("x",r.size_w/2).attr("y",r.size_h/2).text(e),b=d.node().getBBox();return{w:b.width,h:b.height}}function w(){function e(){return navigator&&/firefox/i.test(navigator.userAgent||navigator.vendor||"")}const o=_("m","em"),p=o.h,d=o.w,b=_("x","ex").w,R=e()?"firefox":"*",S=fontMetrics[R][r.labels_fontface]||fontMetrics[R]["*"],L={dy:S.dy*p,top:S.top*b,bot:S.bot*b,inner:S.inner*d,outer:S.outer*d};return L.lblMarginAfter=r.node_border/2+S.marginRight*L.inner,L.lblMarginBefore=r.node_border/2+(S.marginRight+S.marginAdjLeft)*L.inner,L}const m=w(),x=d3.sankey().nodes(t).flows(a).rightJustifyEndpoints(r.layout_justifyends).leftJustifyOrigins(r.layout_justifyorigins).setup();let A=x.stages();const C=A.length+1;if(C!==s.labelNeverBreakpoint){const e=g("labelposition_breakpoint");e.setAttribute("max",C),(r.labelposition_breakpoint>C||r.labelposition_breakpoint===s.labelNeverBreakpoint)&&(e.value=C,r.labelposition_breakpoint=C),s.labelNeverBreakpoint=C}function T(e){return!e.isAShadow||r.internal_revealshadows}r.labelname_appears&&t.filter(T).filter(e=>!e.hideLabel).forEach(e=>{e.labelText=r.labelvalue_appears?`${e.name}: ${l(e.value)}`:e.name;const o=r.labelposition_first==="before"?e.stage<r.labelposition_breakpoint-1:e.stage>=r.labelposition_breakpoint-1;e.label={dom_id:`label${e.index}`,anchor:o?"end":"start"}});function G(e,o){let p=0;return e.filter(d=>d.labelText).forEach(d=>{const b=_(d.labelText,d.dom_id).w+(o?m.lblMarginBefore:m.lblMarginAfter)+m.outer;p=Math.max(p,b)}),p}function K(){const e=r.size_w-r.margin_l-r.margin_r,o=r.size_h-r.margin_t-r.margin_b,p=A.length-1,d=A[0].filter(me=>me.label?.anchor==="end"),b=A[p].filter(me=>me.label?.anchor==="start"),R=d.length>0?G(A[0],!0):r.node_border/2,S=b.length>0?G(A[p],!1):r.node_border/2,L=e-R-S,pe=A.length*r.node_w+p*(r.node_border+5),Le=Math.max(L,pe),Oe=R+S>0?R/(R+S):.5,Ce=L<pe?(L-pe)*Oe:0;return{w:Le,h:o,final_margin_l:r.margin_l+R+Ce}}const $=K();x.size({w:$.w,h:$.h}).nodeWidth(r.node_w).nodeHeightFactor(r.node_h/100).nodeSpacingFactor(r.node_spacing/100).autoLayout(r.layout_order==="automatic").attachIncompletesTo(r.layout_attachincompletesto).layout(r.internal_iterations),A=x.stages();const V=r.node_theme==="none"?[r.node_color]:$e(le(r.node_theme).colorset,r[de(r.node_theme)]),Z=d3.scaleOrdinal(V),z=r.flow_curvature<=.1,B=z?ve:Me(r.flow_curvature),Q=r.bg_color.toUpperCase()<"#888",v=r.labels_color.toUpperCase()<"#AAA",F=highlightStyles[v?"dark":"light"];F.orig.fill_opacity=Number(r.labels_highlight),F.hover.fill_opacity=.666+Number(r.labels_highlight)/3;function ee(){return(A.length-1)/2}t.filter(T).forEach(e=>{if(e.dom_id=`r${e.index}`,e.css_class=`for_${e.dom_id}`,e.tooltip=`${e.name}:
${l(e.value)}`,e.opacity=e.opacity||r.node_opacity,typeof e.color>"u"||e.color===""){const o=(e.name.match(/^\s*(\S+)/)||[null,"name-is-blank"])[1];e.color=e.isAShadow?colorGray60:Z(o)}if(e.border_color=Q?d3.rgb(e.color).brighter(2):d3.rgb(e.color).darker(2),r.labelname_appears&&!e.hideLabel){const o=e.label.anchor==="end";e.label.x=e.x+(o?-m.lblMarginBefore:e.dx+m.lblMarginAfter),e.label.y=e.y+e.dy/2,e.label.dy=m.dy,F.orig.fill_opacity>0&&(e.label.bg={dom_id:`${e.label.dom_id}_bg`,offset:{x:o?-m.outer:-m.inner,y:-m.top,w:m.inner+m.outer,h:m.top+m.bot},...F.orig})}}),a.filter(T).forEach(e=>{if(e.dom_id=`flow${e.index}`,e.tooltip=`${e.source.name} → ${e.target.name}: ${l(e.value)}`,e.opacity=e.opacity||r.flow_opacity,e.opacity_on_hover=.5+Number(e.opacity)/2,e.color==="")if(e.isAShadow)e.color=colorGray60;else if(e.source.paint[AFTER])e.color=e.source.color;else if(e.target.paint[BEFORE])e.color=e.target.color;else{const o=(e.source.stage+e.target.stage)/2;switch(r.flow_inheritfrom){case"source":e.color=e.source.color;break;case"target":e.color=e.target.color;break;case"outside-in":e.color=o<=ee()?e.source.color:e.target.color;break;case"none":e.color=r.flow_color}}e.fill={flat:e.color,curved:"none"},e.stroke_width={flat:.5,curved:Math.max(1,e.dy)}}),we(r);const te=d3.select("#sankey_svg");r.bg_transparent||te.append("rect").attr("height",r.size_h).attr("width",r.size_w).attr("fill",r.bg_color);const P=te.append("g").attr("transform",`translate(${$.final_margin_l},${r.margin_t})`);function j(e,o,p){d3.select(`#${e.dom_id}`).attr("opacity",o),[e.source,e.target].filter(d=>d.label?.bg).forEach(d=>{d3.select(`#${d.label.bg.dom_id}`).attr("fill",p.fill).attr("fill-opacity",h(p.fill_opacity)).attr("stroke",p.stroke).attr("stroke-width",h(p.stroke_width)).attr("stroke-opacity",h(p.stroke_opacity))})}function I(e,o){o.hovering=!0,j(o,o.opacity_on_hover,F.hover)}function re(e,o){j(o,o.opacity,F.orig),o.hovering=!1}const ae=P.append("g").attr("id","sankey_flows").selectAll().data(a.filter(T)).enter().append("path").attr("id",e=>e.dom_id).attr("d",B).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>h(e.stroke_width[e.renderAs])).attr("stroke",e=>e.color).attr("opacity",e=>e.opacity).on("mouseover",I).on("mouseout",re).sort((e,o)=>e.isAShadow-o.isAShadow||o.dy-e.dy);ae.append("title").text(e=>e.tooltip);function J(e){return e.every(o=>o===0)}function E(e){const o=t[e],p=o.move[0]*(r.layout_reversegraph?-1:1),d=$.w-o.dx,b=$.h-o.dy;o.x=Math.max(0,Math.min(d,o.origPos.x+d*p)),o.y=Math.max(0,Math.min(b,o.origPos.y+b*o.move[1])),d3.selectAll(`#sankey_svg .${o.css_class}`).attr("transform",J(o.move)?null:`translate(${h(o.x-o.origPos.x)},${h(o.y-o.origPos.y)})`)}function Y(e){e.lastPos={x:e.x,y:e.y}}function q(e){Y(e),J(e.move)?s.rememberedMoves.delete(e.name):s.rememberedMoves.set(e.name,e.move),he()}function D(){x.relayout(),ae.attr("d",B).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>h(e.stroke_width[e.renderAs]))}function ce(e,o){const p=Se(r.bg_color);let d=P.select("#helper_layer");if(d.nodes.length||(d=P.insert("g","#sankey_nodes").attr("id","helper_layer").attr("fill",p).attr("fill-opacity",.5).attr("stroke","none")),d.append("path").attr("id","helper_lines").attr("d",`M0 ${h(o.lastPos.y)} h${h($.w)} m0 ${h(o.dy)} H0M${h(o.lastPos.x)} 0 v${h($.h)} m${h(o.dx)} 0 V0`).attr("stroke",p).attr("stroke-width",1).attr("stroke-dasharray","1 3").attr("stroke-opacity",.7),d.append("rect").attr("id","helper_original_rect").attr("x",h(o.origPos.x)).attr("y",h(o.origPos.y)).attr("height",h(o.dy)).attr("width",h(o.dx)).attr("fill",o.color).attr("fill-opacity",.3),!(e.sourceEvent&&e.sourceEvent.shiftKey)){const b=d.append("g").attr("id","helper_shift_hints").attr("font-size","14px").attr("font-weight","400");($.h>350?[.05,.95]:[.4]).forEach(S=>{b.append("text").attr("text-anchor","middle").attr("x",$.w/2).attr("y",$.h*S).text("Hold down Shift to move in only one direction")})}return null}function ue(e,o){let p=e.x,d=e.y;const b=g("layout_reversegraph").checked;if(e.sourceEvent&&e.sourceEvent.shiftKey){Math.abs(p-o.lastPos.x)>Math.abs(d-o.lastPos.y)?d=o.lastPos.y:p=o.lastPos.x;const R=P.select("#helper_shift_hints");R.nodes&&R.remove()}return o.move=[(b?-1:1)*((p-o.origPos.x)/($.w-o.dx)),$.h===o.dy?0:(d-o.origPos.y)/($.h-o.dy)],E(o.index),D(),null}function n(e,o){const p=P.select("#helper_layer");return p.nodes&&p.remove(),q(o),a.filter(d=>d.hovering).forEach(d=>{re(null,d)}),D(),null}function u(e,o){return o.move=[0,0],E(o.index),q(o),D(),null}const f=P.append("g").attr("id","sankey_nodes").selectAll(".node").data(t.filter(T)).enter().append("g").attr("class","node").call(d3.drag().on("start",ce).on("drag",ue).on("end",n)).on("dblclick",u);r.node_border&&f.append("rect").attr("id",e=>`${e.dom_id}_border`).attr("class",e=>e.css_class).attr("x",e=>h(e.x)).attr("y",e=>h(e.y)).attr("height",e=>h(e.dy)).attr("width",e=>h(e.dx)).attr("stroke",e=>e.border_color).attr("stroke-width",r.node_border).attr("fill","none"),f.append("rect").attr("id",e=>e.dom_id).attr("class",e=>e.css_class).attr("x",e=>h(e.x)).attr("y",e=>h(e.y)).attr("height",e=>h(e.dy)).attr("width",e=>h(e.dx)).attr("fill",e=>e.color).attr("fill-opacity",e=>e.opacity).append("title").text(e=>e.tooltip);const y=P.append("g").attr("id","sankey_labels").attr("font-family",r.labels_fontface).attr("font-size",`${r.labelname_size}px`).attr("font-weight",r.labelname_weight).attr("fill",r.labels_color);if(r.labelname_appears&&(y.selectAll().data(t.filter(T)).enter().filter(e=>!e.hideLabel).append("text").attr("id",e=>e.label.dom_id).attr("class",e=>e.css_class).attr("text-anchor",e=>e.label.anchor).attr("x",e=>h(e.label.x)).attr("y",e=>h(e.label.y)).attr("dy",e=>e.label.dy).text(e=>e.labelText),t.filter(T).filter(e=>e.label?.bg).forEach(e=>{const o=`#${e.label.dom_id}`,p=y.select(o).node().getBBox(),d=e.label.bg;y.insert("rect",o).attr("id",d.dom_id).attr("class",e.css_class).attr("x",h(p.x+d.offset.x)).attr("y",h(p.y+d.offset.y)).attr("width",h(p.width+d.offset.w)).attr("height",h(p.height+d.offset.h)).attr("rx",h(r.labelname_size/4)).attr("fill",d.fill).attr("fill-opacity",h(d.fill_opacity)).attr("stroke",d.stroke).attr("stroke-width",h(d.stroke_width)).attr("stroke-opacity",h(d.stroke_opacity))})),s.rememberedMoves.size){const e=new Set(s.rememberedMoves.keys());t.filter(T).filter(o=>e.has(o.name)).forEach(o=>{o.move=s.rememberedMoves.get(o.name),E(o.index),Y(o),e.delete(o.name)}),e.forEach(o=>{s.rememberedMoves.delete(o)}),D()}}function Ee(){const t=[];s.rememberedMoves.size&&(t.push(movesMarker,""),s.rememberedMoves.forEach((l,c)=>{t.push(`move ${c} ${h(l[0])}, ${h(l[1])}`)}),t.push(""));let a="";function r(l){const c=a.length;return(c&&l.startsWith(`${a}_`)?`  ${l.substring(c+1)}`:l).replaceAll("_"," ")}const i=new Map([["list",l=>`'${l}'`],["text",l=>`'${l.replaceAll("'","''")}'`]]);return t.push(settingsMarker,""),skmSettings.forEach((l,c)=>{if(c.startsWith("internal_"))return;const _=l[0],w=oe(c,_),m=i.has(_)?i.get(_)(w):w;t.push(`${r(c)} ${m}`),a=c.split("_")[0]}),t.join(`
`)}function ne(t){return t.filter(a=>!(a.startsWith(sourceHeaderPrefix)||a.startsWith(settingsAppliedPrefix)||[settingsMarker,userDataMarker,sourceURLLine,movesMarker].includes(a))).join(`
`).replace(/^\n+/,"").replace(/\n+$/,"")}s.saveDiagramToFile=()=>{const t=ne(N(userInputsField).split(`
`)),a=`${sourceHeaderPrefix} Saved: ${s.humanTimestamp()}
${sourceURLLine}

${userDataMarker}

${t}

${Ee()}
`;se(a,`sankeymatic_${s.fileTimestamp()}_source.txt`)},s.saveDiagramAsJSON=()=>{const t={};skmSettings.forEach((l,c)=>{if(!c.startsWith("internal_")){const _=l[0];t[c]=oe(c,_)}});const a=ne(N(userInputsField).split(`
`)),r={};s.rememberedMoves.size&&s.rememberedMoves.forEach((l,c)=>{r[c]=l});const i={credits:"Made with SankeyMATIC",timestamp:s.humanTimestamp(),flows:a,settings:t,moves:r};se(JSON.stringify(i,null,2),`sankeymatic_${s.fileTimestamp()}.json`)},s.process_sankey=(t=null)=>{let[a,r,i]=[0,0,0];const l=new Map;function c(){const n=(u,f,y)=>`<span style="background-color: ${u};" class="color_sample_${f}" title="${u} from d3 color scheme ${y}">&nbsp;</span>`;for(const u of ke.keys()){const f=le(u),y=N(de(u)),e=$e(f.colorset,y),o=e.map(p=>n(p,e.length,f.d3Name)).join("");g(`theme_${u}_guide`).innerHTML=o,g(`theme_${u}_label`).textContent=f.nickname}}function _(n){const u=n.match(/^-(.*)-$/),f=u!==null;return{trueName:f?u[1]:n,hideLabel:f}}function w(n,u){const f=_(n);if(l.has(f.trueName)){const y=l.get(f.trueName);y.sourceRow>u&&(y.sourceRow=u),y.hideLabel||=f.hideLabel}else l.set(f.trueName,{name:f.trueName,hideLabel:f.hideLabel,sourceRow:u,paintInputs:[]})}function m(n){return l.get(_(n).trueName)}function x(n){w(n.name,n.sourceRow),delete n.sourceRow,reBareColor.test(n.color)&&(n.color=`#${n.color}`);const u=m(n.name);delete n.name,Object.entries(n).forEach(([f,y])=>{typeof y<"u"&&y!==null&&y!==""&&(u[f]=y)})}O.resetAll();const A=N(userInputsField).split(`
`),C=A.map(n=>n.trim().replace(/^\u200B+/,"").replace(/\u200B+$/,"").trim()),T=[],G=new Set,K=new Set;function $(n,u){T.push({value:n,message:u})}let V="";C.forEach((n,u)=>{const f=n.match(reMoveLine);if(f!==null){G.add(u);const[e,o,p]=f.slice(-3);s.rememberedMoves.set(e,[Number(o),Number(p)]),K.add(u);return}const y=n.match(reSettingsValue)??n.match(reSettingsText);if(y!==null){G.add(u);let e=y[1],o=e.replace(/\s+/g,"_");"width height left right top bottom".split(" ").filter(d=>o.endsWith(d)).forEach(d=>{o=o.replace(d,d[0])}),!skmSettings.has(o)&&!/_/.test(o)&&V.length&&(o=`${V}_${o}`,e=`${V} ${e}`),V=o.split("_")[0];const p=skmSettings.get(o);if(p){const d=y[2],b=p[0],R=b==="contained"?{w:N("size_w"),h:N("size_h")}:{},[S,L]=H(p,d,R);if(S){W(o,b,L),K.add(u);return}$(d,`Invalid value for <strong>${e}<strong>`)}else $(e,"Not a valid setting name")}});const Z=[],z=[],B=[];C.filter((n,u)=>!G.has(u)).forEach((n,u)=>{if(n===""||reCommentLine.test(n))return;let f=n.match(reNodeLine);if(f!==null){x({name:f[1].trim(),color:f[2],opacity:f[3],paintInputs:[f[4],f[5]],sourceRow:u});return}if(f=n.match(reFlowLine),f!==null){const y=f[2].replace(/\s/g,"");if(!M(y)){$(n,"The Amount is not a valid decimal number");return}if(y<=0){$(n,"Amounts must be greater than 0");return}Z.push({source:f[1].trim(),target:f[3].trim(),amount:y,sourceRow:u}),a=Math.max(a,(y.split(".")[1]||"").length);return}$(n,"Does not match the format of a Flow or Node or Setting")}),T.forEach(n=>{O.add(`${n.message}: ${xe(n.value)}`,"issue")});const Q=g("layout_reversegraph").checked;Z.forEach(n=>{let[u,f]=["",""];const y=n.target.match(reFlowTargetWithSuffix);if(y!==null){const[,o,p]=y,d=p.match(reColorPlusOpacity);d!==null&&(n.target=o,d[1]&&(u=`#${d[1]}`),d[2]&&(f=d[2]))}w(n.source,n.sourceRow),w(n.target,n.sourceRow+.5);const e={index:B.length,source:m(n.source),target:m(n.target),value:n.amount,color:u,opacity:f,hovering:!1,sourceRow:n.sourceRow};Q&&([e.source,e.target]=[e.target,e.source]),B.push(e)}),Array.from(l.values()).sort((n,u)=>n.sourceRow-u.sourceRow).forEach(n=>{const u=n.paintInputs.some(y=>y==="<<"),f=n.paintInputs.some(y=>y===">>");n.paint={[BEFORE]:Q?f:u,[AFTER]:Q?u:f},delete n.paintInputs,n.index=z.length,z.push(n)});const v={};skmSettings.forEach((n,u)=>{const[f,y]=n,e=oe(u,f),o=f==="contained"?{w:v.size_w,h:v.size_h}:{},[p,d]=H(n,e,o);if(p){v[u]=d;return}const b=Re(y,f);v[u]=b,W(u,f,b)});const F=g("chart");F.style.height=`${v.size_h}px`,F.style.width=`${v.size_w}px`,[1,2,4,6].forEach(n=>{g(`save_as_png_${n}x`).title=`PNG image file: ${v.size_w*n} x ${v.size_h*n}`});const ee=A.map((n,u)=>K.has(u)?`${settingsAppliedPrefix}${n}`:n);if(ee[0].startsWith(sourceHeaderPrefix)?(g(userInputsField).value=ne(ee),t&&O.add(`Imported <strong>${t}</strong>.`)):g(userInputsField).value=ee.join(`
`),!Z.length)return O.add('Enter a list of Flows &mdash; one per line. See the <a href="/manual/" target="_blank">Manual</a> for more help.'),we(v),null;const[te,P]=v.value_format,j={marks:{group:te==="X"?"":te,decimal:P},decimalPlaces:a,trimString:v.labelvalue_fullprecision?"":"~",prefix:v.value_prefix,suffix:v.value_suffix};if(v.layout_reversegraph)switch(v.flow_inheritfrom){case"source":v.flow_inheritfrom="target";break;case"target":v.flow_inheritfrom="source";break}Ne(z,B,v,j);function I(n){return ie(n,j)}function re(n,u){const f=I(n.total[u]),y=n.flows[u].filter(p=>!p.isAShadow),e=y.length;if(e===1)return f;const o=y.map(p=>p.value).sort((p,d)=>d-p).map(p=>I(p)).join(" + ");return`<dfn title="${f} from ${e} Flows: ${o}">${f}</dfn>`}const ae=10**(-a-1),J=[],E={[IN]:0,[OUT]:0};z.forEach((n,u)=>{if(n.total[IN]>0&&n.total[OUT]>0){const f=n.total[IN]-n.total[OUT];Math.abs(f)>ae&&J.push({name:n.name,total:{[IN]:re(n,IN),[OUT]:re(n,OUT)},difference:I(f)})}else E[IN]+=n.total[IN],E[OUT]+=n.total[OUT];n.value>i&&(r=u,i=n.value)});const Y=!J.length;if(["meta_listimbalances","layout_attachto_leading","layout_attachto_trailing","layout_attachto_nearest"].forEach(n=>{g(n).disabled=Y}),g("imbalances_area").setAttribute("aria-disabled",Y),!Y&&v.meta_listimbalances){const n=["<tr><td></td><th>Total In</th><th>Total Out</th><th>Difference</th></tr>"];J.forEach(u=>{n.push(`<tr><td class="nodename">${ge(u.name)}</td><td>${u.total[IN]}</td><td>${u.total[OUT]}</td><td>${u.difference}</td></tr>`)}),O.add(`<table class="center_basic">${n.join(`
`)}</table>`,"difference")}let q=`<strong>${z.length} ノード</strong> 間に <strong>${B.length} フロー</strong>  `;if(Math.abs(E[IN]-E[OUT])>ae){const n=E[IN]>E[OUT]?"&gt;":"&lt;";q+=`Total Inputs: <strong>${I(E[IN])}</strong> ${n} Total Outputs: <strong>${I(E[OUT])}</strong>`}else q+=`トータル・インプット = トータル・アウトプット = <strong>${I(E[IN])}</strong> &#9989;`;O.add(q,"total"),c();const D=parseFloat(g(`r${r}`).getAttributeNS(null,"height")),ce=_e(d3.format(",.2~f")(D),j.marks),ue=ie(i/D,{...j,decimalPlaces:4});return g("scale_figures").innerHTML=`<strong>${ue}</strong> per pixel (${I(i)}/${ce}px)`,he(),null},s.process_sankey(),s.loadDiagramFile=async()=>{const t=g("load_diagram_from_file").files;if(t.length===0)return;const a=await t[0].text(),r=t[0].name;if(a.trim().startsWith("{"))try{const i=JSON.parse(a);typeof i.flows=="string"&&(g(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,c])=>{const _=skmSettings.get(l);if(_){const[w,m]=H(_,c,{});w&&W(l,_[0],m)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,c])=>{s.rememberedMoves.set(l,c)})),s.process_sankey(r);return}catch(i){console.warn("File looked like JSON but failed to parse:",i)}g(userInputsField).value=a,s.process_sankey(r)};function Te(t){const a=atob(t.split(",")[1]),r=t.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(a.length),l=new Uint8Array(i);for(let c=0;c<a.length;c++)l[c]=a.charCodeAt(c);return new Blob([i],{type:r})}s.saveCloudProjectUI=()=>{const t={};skmSettings.forEach((w,m)=>{if(!m.startsWith("internal_")){const x=w[0];t[m]=oe(m,x)}});const a=ne(N(userInputsField).split(`
`)),r={};s.rememberedMoves.forEach((w,m)=>{r[m]=w});const i={metadata:{saved_at:new Date().toISOString(),generator:"SankeyMATIC",version:"1.0"},settings:t,flows:a,moves:r},[l,c]=ye(1),_=Te(c);window.CloudUI.openSaveModal(i,_)},s.loadCloudProjectUI=()=>{window.CloudUI.openLoadModal(t=>{s.loadProjectData(t)})},s.loadProjectData=t=>{typeof t.flows=="string"&&(g(userInputsField).value=t.flows),t.settings&&typeof t.settings=="object"&&Object.entries(t.settings).forEach(([a,r])=>{const i=skmSettings.get(a);if(i){const[l,c]=H(i,r,{});l&&W(a,i[0],c)}}),t.moves&&typeof t.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(t.moves).forEach(([a,r])=>{s.rememberedMoves.set(a,r)})),s.process_sankey()},window.addEventListener("dataviz-save-trigger",()=>{s.saveDiagramAsJSON()}),window.addEventListener("dataviz-load-trigger",async t=>{if(t.detail&&t.detail.file){const a=t.detail.file,r=await a.text();if(r.trim().startsWith("{"))try{const i=JSON.parse(r);typeof i.flows=="string"&&(g(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,c])=>{const _=skmSettings.get(l);if(_){const[w,m]=H(_,c,{});w&&W(l,_[0],m)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,c])=>{s.rememberedMoves.set(l,c)})),s.process_sankey(a.name);return}catch(i){console.warn("JSON parse error from header load:",i)}g(userInputsField).value=r,s.process_sankey(a.name)}}),window.addEventListener("load",()=>{const a=new URLSearchParams(window.location.search).get("project_id")||window.SKM_PROJECT_ID;if(a){console.log("Found project_id:",a);let r=0;const i=setInterval(async()=>{if(r++,r>50){clearInterval(i),console.error("Timeout waiting for CloudApi/Supabase");return}if(window.CloudApi&&window.supabase){clearInterval(i);const{data:{session:l}}=await window.supabase.auth.getSession();if(l){const c=document.createElement("div");c.textContent="Loading Project...",c.style.cssText="position:fixed;top:10px;right:10px;background:#036;color:#fff;padding:15px;border-radius:5px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.3);",document.body.appendChild(c);try{const _=await window.CloudApi.loadProject(a);console.log("Project loaded:",_);let w=_;if(w.data&&!w.flows&&!w.settings&&(w=w.data),typeof w=="string"&&w.trim().startsWith("{"))try{w=JSON.parse(w)}catch{}s.loadProjectData(w);const m=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({path:m},"",m)}catch(_){console.error("Auto-load failed",_),alert("プロジェクトの読み込みに失敗しました: "+_.message)}finally{c.remove()}}else console.warn("No session found for auto-load")}},500)}})})(window==="undefined"?global:window);
