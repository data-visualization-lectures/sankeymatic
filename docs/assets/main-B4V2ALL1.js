(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const b of document.querySelectorAll('link[rel="modulepreload"]'))A(b);new MutationObserver(b=>{for(const S of b)if(S.type==="childList")for(const D of S.addedNodes)D.tagName==="LINK"&&D.rel==="modulepreload"&&A(D)}).observe(document,{childList:!0,subtree:!0});function h(b){const S={};return b.integrity&&(S.integrity=b.integrity),b.referrerPolicy&&(S.referrerPolicy=b.referrerPolicy),b.crossOrigin==="use-credentials"?S.credentials="include":b.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function A(b){if(b.ep)return;b.ep=!0;const S=h(b);fetch(b.href,S)}})();(function(){if(window.location.search){const F=new URLSearchParams(window.location.search).get("project_id");F&&(window.SKM_PROJECT_ID=F,console.log("Rescued project_id:",F))}})();window.skmSettings=new Map([["size_w",["whole",600,[40]]],["size_h",["whole",600,[40]]],["margin_l",["contained",12,[0,"w"]]],["margin_r",["contained",12,[0,"w"]]],["margin_t",["contained",18,[0,"h"]]],["margin_b",["contained",20,[0,"h"]]],["bg_color",["color","#ffffff",[]]],["bg_transparent",["yn","n",[]]],["node_w",["contained",9,[0,"w"]]],["node_h",["whole",50,[0,100]]],["node_spacing",["whole",85,[0,100]]],["node_border",["contained",0,[0,"w"]]],["node_theme",["radio","none",["a","b","c","d","none"]]],["node_color",["color","#888888",[]]],["node_opacity",["decimal",1,[]]],["flow_curvature",["decimal",.5,[]]],["flow_inheritfrom",["radio","none",["source","target","outside-in","none"]]],["flow_color",["color","#999999",[]]],["flow_opacity",["decimal",.45,[]]],["layout_order",["radio","automatic",["automatic","exact"]]],["layout_justifyorigins",["yn","n",[]]],["layout_justifyends",["yn","n",[]]],["layout_reversegraph",["yn","n",[]]],["layout_attachincompletesto",["radio","nearest",["leading","nearest","trailing"]]],["labels_color",["color","#000000",[]]],["labels_highlight",["decimal",.55,[]]],["labels_fontface",["radio","sans-serif",["monospace","sans-serif","serif"]]],["labelname_appears",["yn","y",[]]],["labelname_size",["whole",16,[6]]],["labelname_weight",["radio","400",["100","400","700"]]],["labelvalue_appears",["yn","y",[]]],["labelvalue_fullprecision",["yn","y",[]]],["labelposition_first",["radio","before",["before","after"]]],["labelposition_breakpoint",["breakpoint",9999,[2]]],["value_format",["list",",.",[",.",".,"," ."," ,","X.","X,"]]],["value_prefix",["text","",[0,99]]],["value_suffix",["text","",[0,99]]],["themeoffset_a",["whole",9,[0,9]]],["themeoffset_b",["whole",0,[0,9]]],["themeoffset_c",["whole",0,[0,7]]],["themeoffset_d",["whole",0,[0,11]]],["meta_listimbalances",["yn","y",[]]],["internal_iterations",["whole",25,[0,50]]],["internal_revealshadows",["yn","n",[]]]]);window.reWholeNumber=/^\d+$/;window.reDecimal=/^\d(?:.\d+)?$/;window.reCommentLine=/^(?:'|\/\/)/;window.reYesNo=/^(?:y|yes|n|no)/i;window.reYes=/^(?:y|yes)/i;window.reSettingsValue=/^((?:\w+\s*){1,2}) (#?[\w.-]+)$/;window.reSettingsText=/^((?:\w+\s*){1,2}) '(.*)'$/;window.reMoveLine=/^move (.+) (-?\d(?:.\d+)?), (-?\d(?:.\d+)?)$/;window.sourceHeaderPrefix="// SankeyMATIC diagram inputs -";window.sourceURLLine="// https://sankeymatic.com/build/";window.userDataMarker="// === Nodes and Flows ===";window.movesMarker="// === Moved Nodes ===";window.settingsMarker="// === Settings ===";window.settingsAppliedPrefix="// ✓ ";window.reNodeLine=/^:(.+) #([a-f0-9]{0,6})?(\.\d{1,4})?\s*(>>|<<)*\s*(>>|<<)*$/i;window.reFlowLine=/^(.+)\[([\d\s.+-]+)\](.+)$/;window.reFlowTargetWithSuffix=/^(.+)\s+(#\S+)$/;window.reColorPlusOpacity=/^#([a-f0-9]{3,6})?(\.\d{1,4})?$/i;window.reBareColor=/^(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.reRGBColor=/^#(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.colorGray60="#999";window.userInputsField="flows_in";window.IN=13;window.OUT=17;window.BEFORE=19;window.AFTER=23;window.fontMetrics={firefox:{"sans-serif":{dy:.35,top:.55,bot:.25,inner:.35,outer:.35,marginRight:1.4,marginAdjLeft:0},monospace:{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.48,marginAdjLeft:-.08},"*":{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.35,marginAdjLeft:-.05}},"*":{monospace:{dy:.28,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.45,marginAdjLeft:0},"*":{dy:.29,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.35,marginAdjLeft:0}}};window.highlightStyles={dark:{orig:{fill:"#fff",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#ffb",stroke:"#440",stroke_width:1,stroke_opacity:.7}},light:{orig:{fill:"#000",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#603",stroke:"#fff",stroke_width:1.7,stroke_opacity:.9}}};window.sampleDiagramRecipes=new Map([["default_budget",{name:"Basic Budget",flows:`// Enter Flows between Nodes, like this:
//         Source [AMOUNT] Target

Wages [1500] Budget
Other [250] Budget

Budget [450] Taxes
Budget [420] Housing
Budget [400] Food
Budget [295] Transportation
Budget [25] Savings

// You can set a Node's color, like this:
:Budget #708090
//            ...or a color for a single Flow:
Budget [160] Other Necessities #0F0

// Use the controls below to customize
// your diagram's appearance...`,settings:{size_w:600,node_w:9,node_h:50,node_spacing:85,node_theme:"a",flow_inheritfrom:"outside-in",layout_justifyends:"n",layout_order:"automatic",labelname_size:16,value_prefix:""}}],["election",{name:"Ranked Election",flows:`// Sample Ranked Election diagram

GH - Round 1 [300000] GH - Round 2
EF - Round 1 [220000] EF - Round 2
CD - Round 1 [200000] CD - Round 2
AB - Round 1 [10000] GH - Round 2
AB - Round 1 [25000] EF - Round 2
AB - Round 1 [20000] CD - Round 2

GH - Round 2 [310000] GH - Round 3
EF - Round 2 [245000] EF - Round 3
CD - Round 2 [50000] GH - Round 3
CD - Round 2 [95000] EF - Round 3

// This line sets a custom gray color:
:No further votes #555 <<
AB - Round 1 [20000] No further votes
CD - Round 2 [75000] No further votes`,settings:{size_w:700,node_w:9,node_h:76,node_spacing:85,node_theme:"a",flow_inheritfrom:"source",layout_justifyends:"n",layout_order:"exact",labelname_size:14,value_prefix:""}}],["job_search",{name:"Job Search",flows:`// Sample Job Search diagram:

Applications [4] Interview
Applications [9] Rejected
Applications [4] No Answer

Interview [2] 2nd Interview
Interview [2] No Offer

2nd Interview [2] Offer

Offer [1] Accepted
Offer [1] Declined`,settings:{size_w:700,node_w:5,node_h:50,node_spacing:50,node_theme:"a",flow_inheritfrom:"target",layout_justifyends:"n",layout_order:"automatic",labelname_size:14,value_prefix:""}}],["financial_results",{name:"Financial Results",flows:`Division A [900] Revenue
Division B [750] Revenue
Division C [150] Revenue

Revenue [1000] Gross Profit

Gross Profit [350] Operating Profit
Gross Profit [650] Operating Expenses

Operating Profit [260] Net Profit
Operating Profit [90] Tax

Operating Expenses [640] S G & Admin
Operating Expenses [10] Amortization

Revenue [800] Cost of Sales

// Profit - blue
:Gross Profit #48e <<
:Operating Profit #48e <<
:Net Profit #48e <<

// Expenses - rust
:Operating Expenses #d74 <<
:Tax #d74 <<
:S G & Admin #d74 <<
:Amortization #d74 <<

// Cost - grayish-gold
:Cost of Sales #e6cc91 <<

// main Revenue node: dark grey
:Revenue #444`,settings:{size_w:1e3,node_w:5,node_h:70,node_spacing:70,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"y",layout_order:"automatic",labelname_size:13,value_prefix:"$"}}],["simple_start",{name:"Start Simple",flows:`a [1] b
a [1] c`,settings:{size_w:600,node_w:12,node_h:50,node_spacing:80,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"n",layout_order:"automatic",labelname_size:15,value_prefix:""}}]]);(function(s){function h(t){return document.getElementById(t)}function A(t){return document.getElementById(t).value}s.togglePanel=t=>{const o=h(t),a=o.tagName==="SPAN"?"inline":"",i=o.style.display==="none"?{display:a,suffix:":",action:"–"}:{display:"none",suffix:"...",action:"+"};return o.style.display=i.display,h(`${t}_hint`).textContent=i.suffix,h(`${t}_indicator`).textContent=i.action,null};function b(t){return h(`${t}_val`)}s.labelNeverBreakpoint=9999,s.updateOutput=t=>{const o=A(t),a=b(t);switch({node_h:"%",node_spacing:"%",node_opacity:".2",flow_curvature:"|",flow_opacity:".2",labels_highlight:".2",labelposition_breakpoint:"never"}[t]){case"|":if(o<=.1){a.textContent="0.00";break}case".2":a.textContent=d3.format(".2f")(o);break;case"%":a.textContent=`${o}%`;break;case"never":a.textContent=Number(o)===s.labelNeverBreakpoint?"∅":o;break;default:a.textContent=o}return null},s.revealVal=t=>{s.updateOutput(t);const o=b(t).classList;return o.remove("fade-init","fade-out"),o.add("fade-in"),null},s.fadeVal=t=>(b(t).classList.replace("fade-in","fade-out"),null);function S(t){return!Number.isNaN(t-parseFloat(t))}function D(t,o,a){return S(t)?Math.min(Math.max(t,o),a):o}function Z(t){return document.forms.skm_form.elements[t]}s.checkRadio=t=>{h(t).checked=!0},s.rememberedMoves=new Map,s.resetMovesAndRender=()=>(s.rememberedMoves.clear(),s.process_sankey(),null);function E(){h("reset_all_moved_nodes").disabled=!s.rememberedMoves.size}function Q(t){const o=d3.rgb(t),a=(o.r*299+o.g*587+o.b*114)/1e3,i=Math.floor(a>164?.75*a-64:.3*a+192);return d3.rgb(i,i,i)}function se(t){return t.replaceAll("→","&#8594;").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;").replaceAll(`
`,"<br />")}function f(t){return Number(t.toFixed(5)).toString()}function we(t,o){return o.group===","?t:t.replaceAll(",","!").replaceAll(".",o.decimal).replaceAll("!",o.group)}function ce(t,o){const a=we(d3.format(`,.${o.decimalPlaces}${o.trimString}f`)(t),o.marks);return`${o.prefix}${a}${o.suffix}`}function ye(t){const o=h("sankey_svg");o.setAttribute("height",t.size_h),o.setAttribute("width",t.size_w),o.setAttribute("class",`svg_background_${t.bg_transparent?"transparent":"default"}`),o.textContent=""}const Me=d3.timeFormat("%Y%m%d_%H%M%S");s.fileTimestamp=()=>Me(new Date),s.humanTimestamp=()=>new Date().toLocaleString();async function ve(t){const o=h("chart"),a={w:o.clientWidth,h:o.clientHeight},i=D(t,1,6),l={w:a.w*i,h:a.h*i},p={x:(l.w-a.w)/(2*i),y:(l.h-a.h)/(2*i)},_=h("png_preview"),w=_.getContext("2d"),g=new XMLSerializer().serializeToString(h("sankey_svg"));return _.width=l.w,_.height=l.h,await(await canvg.Canvg.fromString(w,g,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,scaleWidth:l.w,scaleHeight:l.h,offsetX:p.x,offsetY:p.y})).render(),[l,_.toDataURL("image/png")]}function be(t,o){const a=document.createElement("a");a.style.display="none",a.href=t,a.download=o,document.body.append(a),a.click(),a.remove()}s.saveDiagramAsPNG=async t=>{const[o,a]=await ve(t);be(a,`sankeymatic_${s.fileTimestamp()}_${o.w}x${o.h}.png`)};function ue(t,o){const a=new Blob([t],{type:"text/plain"}),i=URL.createObjectURL(a);be(i,o),URL.revokeObjectURL(i)}s.saveDiagramAsSVG=()=>{const t=h("sankey_svg").outerHTML.replace(' id="sankey_svg"',"").replace(/ class="svg_background_[a-z]+"/,"").replace(/>/,`>\r
<title>Your Diagram Title</title>\r
<!-- Generated with SankeyMATIC: ${s.humanTimestamp()} -->\r
`).replace(/><(g|\/g|path|text|rect)/g,`>\r
<$1`);ue(t,`sankeymatic_${s.fileTimestamp()}.svg`)};function xe(t){const o=t.source.x+t.source.dx,a=t.target.x,i=t.source.y+t.sy,l=t.target.y+t.ty+t.dy;return t.renderAs="flat",`M${f(o)} ${f(i)}v${f(t.dy)}L${f(a)} ${f(l)}v${f(-t.dy)}z`}function Ae(t){return o=>{const a=o.source.y+o.sy+o.dy/2,i=o.target.y+o.ty+o.dy/2,l=o.source.x+o.source.dx,p=o.target.x;if(Math.abs(a-i)<2||Math.abs(p-l)<12)return xe(o);o.renderAs="curved";const _=d3.interpolateNumber(l,p),w=_(t),g=_(1-t);return`M${f(l)} ${f(a)}C${f(w)} ${f(a)} ${f(g)} ${f(i)} ${f(p)} ${f(i)}`}}function W(t,o,a){const[i,l,p]=t;if(i==="yn"&&reYesNo.test(o))return[!0,reYes.test(o)];if(["radio","list"].includes(i)&&p.includes(o))return[!0,o];if(i==="color"){let g;if(reRGBColor.test(o))g=d3.rgb(o);else if(reBareColor.test(o))g=d3.rgb(`#${o}`);else{const $=d3.color(o);$&&(g=$)}if(g)return[!0,g.formatHex()]}function _(g,[$,R]){return g>=$&&(R===void 0||g<=R)}if(i==="text"){const g=o.replaceAll("''","'");if(_(g.length,p))return[!0,g]}const w=Number(o);if(i==="decimal"&&reDecimal.test(o)&&_(w,[0,1]))return[!0,w];if(["whole","contained","breakpoint"].includes(i)&&reWholeNumber.test(o)){let[g,$]=[0];switch(i){case"whole":[g,$]=p;break;case"contained":$=a[p[1]];break;case"breakpoint":$=l;break}if(_(w,[g,$]))return[!0,w]}return[!1]}function V(t,o,a){switch(o){case"radio":Z(t).value=a;break;case"yn":h(t).checked=a;break;default:h(t).value=a}}function le(t,o){switch(o){case"radio":return Z(t).value;case"color":return h(t).value.toLowerCase();case"yn":return h(t)?.checked?"Y":"N";case"list":case"text":return h(t).value;default:return Number(h(t).value)}}function Re(t,o){switch(o){case"whole":case"decimal":case"contained":case"breakpoint":return Number(t);case"yn":return reYes.test(t);default:return t}}function ke(t){return`&quot;<strong>${se(t)}</strong>&quot;`}const O={areas:new Map([["issue",{id:"issue_messages",class:"errormessage"}],["difference",{id:"imbalance_messages",class:"differencemessage"}],["total",{id:"totals_area",class:""}],["info",{id:"info_messages",class:"okmessage"}]]),add:(t,o="info")=>{const a=O.areas.get(o)||O.areas.get("info"),i=document.createElement("div");i.innerHTML=t,a.class.length&&i.classList.add(a.class),h(a.id).append(i)},resetAll:()=>{Array.from(O.areas.values()).map(t=>t.id).forEach(t=>{h(t).replaceChildren()})}};s.hideReplaceGraphWarning=()=>(h("replace_graph_warning").style.display="none",null),s.replaceGraphConfirmed=()=>{const t=A("demo_graph_chosen"),o=sampleDiagramRecipes.get(t);Object.entries(o.settings).forEach(([l,p])=>{const _=skmSettings.get(l),[w,g]=W(_,p,{});w&&V(l,_[0],g)});const a="input_options";h(a).style.display==="none"&&s.togglePanel(a);const i=h(userInputsField);return i.focus(),i.select(),i.setRangeText(o.flows,0,i.selectionEnd,"start"),i.blur(),s.hideReplaceGraphWarning(),s.resetMovesAndRender(),null},s.replaceGraph=t=>{const o=sampleDiagramRecipes.get(t);if(!o)return O.add(`Requested sample diagram ${ke(t)} not found.`,"issue"),null;h("demo_graph_chosen").value=t;const a=A(userInputsField);return Array.from(sampleDiagramRecipes.values()).some(l=>l.flows===a)||a===""?s.replaceGraphConfirmed():(h("replace_graph_warning").style.display="",h("replace_graph_yes").textContent=`はい '${o.name}'と置き換えてください`),null};const $e=new Map([["a",{colorset:d3.schemeCategory10,nickname:"Categories",d3Name:"Category10"}],["b",{colorset:d3.schemeTableau10,nickname:"Tableau10",d3Name:"Tableau10"}],["c",{colorset:d3.schemeDark2,nickname:"Dark",d3Name:"Dark2"}],["d",{colorset:d3.schemeSet3,nickname:"Varied",d3Name:"Set3"}]]);function pe(t){return $e.get(t.toLowerCase())||{colorset:[],nickname:"Invalid Theme",d3Name:"?"}}function Se(t,o){const a=D(o,0,t.length);return t.slice(a).concat(t.slice(0,a))}function me(t){return`themeoffset_${t}`}s.nudgeColorTheme=(t,o)=>{const a=h(me(t)),i=a===null?0:a.value,l=pe(t).colorset.length,p=(l+ +i+ +o)%l;return a.value=p,h(`theme_${t}_radio`).checked=!0,s.process_sankey(),null};function Ne(t,o,a,i){function l(e){return ce(e,i)}const p=d3.select("#svg_scratch").attr("height",a.size_h).attr("width",a.size_w).attr("text-anchor","middle").attr("opacity","0").attr("font-family",a.labels_fontface).attr("font-size",`${a.labelname_size}px`).attr("font-weight",a.labelname_weight);p.selectAll("*").remove();function _(e,r){const u=`bb_${r}`,d=p.append("text").attr("id",u).attr("x",a.size_w/2).attr("y",a.size_h/2).text(e),v=d.node().getBBox();return{w:v.width,h:v.height}}function w(){function e(){return navigator&&/firefox/i.test(navigator.userAgent||navigator.vendor||"")}const r=_("m","em"),u=r.h,d=r.w,v=_("x","ex").w,N=e()?"firefox":"*",M=fontMetrics[N][a.labels_fontface]||fontMetrics[N]["*"],C={dy:M.dy*u,top:M.top*v,bot:M.bot*v,inner:M.inner*d,outer:M.outer*d};return C.lblMarginAfter=a.node_border/2+M.marginRight*C.inner,C.lblMarginBefore=a.node_border/2+(M.marginRight+M.marginAdjLeft)*C.inner,C}const g=w(),$=d3.sankey().nodes(t).flows(o).rightJustifyEndpoints(a.layout_justifyends).leftJustifyOrigins(a.layout_justifyorigins).setup();let R=$.stages();const P=R.length+1;if(P!==s.labelNeverBreakpoint){const e=h("labelposition_breakpoint");e.setAttribute("max",P),(a.labelposition_breakpoint>P||a.labelposition_breakpoint===s.labelNeverBreakpoint)&&(e.value=P,a.labelposition_breakpoint=P),s.labelNeverBreakpoint=P}function T(e){return!e.isAShadow||a.internal_revealshadows}a.labelname_appears&&t.filter(T).filter(e=>!e.hideLabel).forEach(e=>{e.labelText=a.labelvalue_appears?`${e.name}: ${l(e.value)}`:e.name;const r=a.labelposition_first==="before"?e.stage<a.labelposition_breakpoint-1:e.stage>=a.labelposition_breakpoint-1;e.label={dom_id:`label${e.index}`,anchor:r?"end":"start"}});function J(e,r){let u=0;return e.filter(d=>d.labelText).forEach(d=>{const v=_(d.labelText,d.dom_id).w+(r?g.lblMarginBefore:g.lblMarginAfter)+g.outer;u=Math.max(u,v)}),u}function ee(){const e=a.size_w-a.margin_l-a.margin_r,r=a.size_h-a.margin_t-a.margin_b,u=R.length-1,d=R[0].filter(_e=>_e.label?.anchor==="end"),v=R[u].filter(_e=>_e.label?.anchor==="start"),N=d.length>0?J(R[0],!0):a.node_border/2,M=v.length>0?J(R[u],!1):a.node_border/2,C=e-N-M,ge=R.length*a.node_w+u*(a.node_border+5),Le=Math.max(C,ge),Te=N+M>0?N/(N+M):.5,Ce=C<ge?(C-ge)*Te:0;return{w:Le,h:r,final_margin_l:a.margin_l+N+Ce}}const k=ee();$.size({w:k.w,h:k.h}).nodeWidth(a.node_w).nodeHeightFactor(a.node_h/100).nodeSpacingFactor(a.node_spacing/100).autoLayout(a.layout_order==="automatic").attachIncompletesTo(a.layout_attachincompletesto).layout(a.internal_iterations),R=$.stages();const Y=a.node_theme==="none"?[a.node_color]:Se(pe(a.node_theme).colorset,a[me(a.node_theme)]),te=d3.scaleOrdinal(Y),B=a.flow_curvature<=.1,U=B?xe:Ae(a.flow_curvature),ae=a.bg_color.toUpperCase()<"#888",x=a.labels_color.toUpperCase()<"#AAA",I=highlightStyles[x?"dark":"light"];I.orig.fill_opacity=Number(a.labels_highlight),I.hover.fill_opacity=.666+Number(a.labels_highlight)/3;function oe(){return(R.length-1)/2}t.filter(T).forEach(e=>{if(e.dom_id=`r${e.index}`,e.css_class=`for_${e.dom_id}`,e.tooltip=`${e.name}:
${l(e.value)}`,e.opacity=e.opacity||a.node_opacity,typeof e.color>"u"||e.color===""){const r=(e.name.match(/^\s*(\S+)/)||[null,"name-is-blank"])[1];e.color=e.isAShadow?colorGray60:te(r)}if(e.border_color=ae?d3.rgb(e.color).brighter(2):d3.rgb(e.color).darker(2),a.labelname_appears&&!e.hideLabel){const r=e.label.anchor==="end";e.label.x=e.x+(r?-g.lblMarginBefore:e.dx+g.lblMarginAfter),e.label.y=e.y+e.dy/2,e.label.dy=g.dy,I.orig.fill_opacity>0&&(e.label.bg={dom_id:`${e.label.dom_id}_bg`,offset:{x:r?-g.outer:-g.inner,y:-g.top,w:g.inner+g.outer,h:g.top+g.bot},...I.orig})}}),o.filter(T).forEach(e=>{if(e.dom_id=`flow${e.index}`,e.tooltip=`${e.source.name} → ${e.target.name}: ${l(e.value)}`,e.opacity=e.opacity||a.flow_opacity,e.opacity_on_hover=.5+Number(e.opacity)/2,e.color==="")if(e.isAShadow)e.color=colorGray60;else if(e.source.paint[AFTER])e.color=e.source.color;else if(e.target.paint[BEFORE])e.color=e.target.color;else{const r=(e.source.stage+e.target.stage)/2;switch(a.flow_inheritfrom){case"source":e.color=e.source.color;break;case"target":e.color=e.target.color;break;case"outside-in":e.color=r<=oe()?e.source.color:e.target.color;break;case"none":e.color=a.flow_color}}e.fill={flat:e.color,curved:"none"},e.stroke_width={flat:.5,curved:Math.max(1,e.dy)}}),ye(a);const re=d3.select("#sankey_svg");a.bg_transparent||re.append("rect").attr("height",a.size_h).attr("width",a.size_w).attr("fill",a.bg_color);const j=re.append("g").attr("transform",`translate(${k.final_margin_l},${a.margin_t})`);function H(e,r,u){d3.select(`#${e.dom_id}`).attr("opacity",r),[e.source,e.target].filter(d=>d.label?.bg).forEach(d=>{d3.select(`#${d.label.bg.dom_id}`).attr("fill",u.fill).attr("fill-opacity",f(u.fill_opacity)).attr("stroke",u.stroke).attr("stroke-width",f(u.stroke_width)).attr("stroke-opacity",f(u.stroke_opacity))})}function z(e,r){r.hovering=!0,H(r,r.opacity_on_hover,I.hover)}function ne(e,r){H(r,r.opacity,I.orig),r.hovering=!1}const ie=j.append("g").attr("id","sankey_flows").selectAll().data(o.filter(T)).enter().append("path").attr("id",e=>e.dom_id).attr("d",U).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>f(e.stroke_width[e.renderAs])).attr("stroke",e=>e.color).attr("opacity",e=>e.opacity).on("mouseover",z).on("mouseout",ne).sort((e,r)=>e.isAShadow-r.isAShadow||r.dy-e.dy);ie.append("title").text(e=>e.tooltip);function q(e){return e.every(r=>r===0)}function L(e){const r=t[e],u=r.move[0]*(a.layout_reversegraph?-1:1),d=k.w-r.dx,v=k.h-r.dy;r.x=Math.max(0,Math.min(d,r.origPos.x+d*u)),r.y=Math.max(0,Math.min(v,r.origPos.y+v*r.move[1])),d3.selectAll(`#sankey_svg .${r.css_class}`).attr("transform",q(r.move)?null:`translate(${f(r.x-r.origPos.x)},${f(r.y-r.origPos.y)})`)}function X(e){e.lastPos={x:e.x,y:e.y}}function K(e){X(e),q(e.move)?s.rememberedMoves.delete(e.name):s.rememberedMoves.set(e.name,e.move),E()}function G(){$.relayout(),ie.attr("d",U).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>f(e.stroke_width[e.renderAs]))}function fe(e,r){const u=Q(a.bg_color);let d=j.select("#helper_layer");if(d.nodes.length||(d=j.insert("g","#sankey_nodes").attr("id","helper_layer").attr("fill",u).attr("fill-opacity",.5).attr("stroke","none")),d.append("path").attr("id","helper_lines").attr("d",`M0 ${f(r.lastPos.y)} h${f(k.w)} m0 ${f(r.dy)} H0M${f(r.lastPos.x)} 0 v${f(k.h)} m${f(r.dx)} 0 V0`).attr("stroke",u).attr("stroke-width",1).attr("stroke-dasharray","1 3").attr("stroke-opacity",.7),d.append("rect").attr("id","helper_original_rect").attr("x",f(r.origPos.x)).attr("y",f(r.origPos.y)).attr("height",f(r.dy)).attr("width",f(r.dx)).attr("fill",r.color).attr("fill-opacity",.3),!(e.sourceEvent&&e.sourceEvent.shiftKey)){const v=d.append("g").attr("id","helper_shift_hints").attr("font-size","14px").attr("font-weight","400");(k.h>350?[.05,.95]:[.4]).forEach(M=>{v.append("text").attr("text-anchor","middle").attr("x",k.w/2).attr("y",k.h*M).text("Hold down Shift to move in only one direction")})}return null}function he(e,r){let u=e.x,d=e.y;const v=h("layout_reversegraph").checked;if(e.sourceEvent&&e.sourceEvent.shiftKey){Math.abs(u-r.lastPos.x)>Math.abs(d-r.lastPos.y)?d=r.lastPos.y:u=r.lastPos.x;const N=j.select("#helper_shift_hints");N.nodes&&N.remove()}return r.move=[(v?-1:1)*((u-r.origPos.x)/(k.w-r.dx)),k.h===r.dy?0:(d-r.origPos.y)/(k.h-r.dy)],L(r.index),G(),null}function n(e,r){const u=j.select("#helper_layer");return u.nodes&&u.remove(),K(r),o.filter(d=>d.hovering).forEach(d=>{ne(null,d)}),G(),null}function c(e,r){return r.move=[0,0],L(r.index),K(r),G(),null}const m=j.append("g").attr("id","sankey_nodes").selectAll(".node").data(t.filter(T)).enter().append("g").attr("class","node").call(d3.drag().on("start",fe).on("drag",he).on("end",n)).on("dblclick",c);a.node_border&&m.append("rect").attr("id",e=>`${e.dom_id}_border`).attr("class",e=>e.css_class).attr("x",e=>f(e.x)).attr("y",e=>f(e.y)).attr("height",e=>f(e.dy)).attr("width",e=>f(e.dx)).attr("stroke",e=>e.border_color).attr("stroke-width",a.node_border).attr("fill","none"),m.append("rect").attr("id",e=>e.dom_id).attr("class",e=>e.css_class).attr("x",e=>f(e.x)).attr("y",e=>f(e.y)).attr("height",e=>f(e.dy)).attr("width",e=>f(e.dx)).attr("fill",e=>e.color).attr("fill-opacity",e=>e.opacity).append("title").text(e=>e.tooltip);const y=j.append("g").attr("id","sankey_labels").attr("font-family",a.labels_fontface).attr("font-size",`${a.labelname_size}px`).attr("font-weight",a.labelname_weight).attr("fill",a.labels_color);if(a.labelname_appears&&(y.selectAll().data(t.filter(T)).enter().filter(e=>!e.hideLabel).append("text").attr("id",e=>e.label.dom_id).attr("class",e=>e.css_class).attr("text-anchor",e=>e.label.anchor).attr("x",e=>f(e.label.x)).attr("y",e=>f(e.label.y)).attr("dy",e=>e.label.dy).text(e=>e.labelText),t.filter(T).filter(e=>e.label?.bg).forEach(e=>{const r=`#${e.label.dom_id}`,u=y.select(r).node().getBBox(),d=e.label.bg;y.insert("rect",r).attr("id",d.dom_id).attr("class",e.css_class).attr("x",f(u.x+d.offset.x)).attr("y",f(u.y+d.offset.y)).attr("width",f(u.width+d.offset.w)).attr("height",f(u.height+d.offset.h)).attr("rx",f(a.labelname_size/4)).attr("fill",d.fill).attr("fill-opacity",f(d.fill_opacity)).attr("stroke",d.stroke).attr("stroke-width",f(d.stroke_width)).attr("stroke-opacity",f(d.stroke_opacity))})),s.rememberedMoves.size){const e=new Set(s.rememberedMoves.keys());t.filter(T).filter(r=>e.has(r.name)).forEach(r=>{r.move=s.rememberedMoves.get(r.name),L(r.index),X(r),e.delete(r.name)}),e.forEach(r=>{s.rememberedMoves.delete(r)}),G()}}function Ee(){const t=[];s.rememberedMoves.size&&(t.push(movesMarker,""),s.rememberedMoves.forEach((l,p)=>{t.push(`move ${p} ${f(l[0])}, ${f(l[1])}`)}),t.push(""));let o="";function a(l){const p=o.length;return(p&&l.startsWith(`${o}_`)?`  ${l.substring(p+1)}`:l).replaceAll("_"," ")}const i=new Map([["list",l=>`'${l}'`],["text",l=>`'${l.replaceAll("'","''")}'`]]);return t.push(settingsMarker,""),skmSettings.forEach((l,p)=>{if(p.startsWith("internal_"))return;const _=l[0],w=le(p,_),g=i.has(_)?i.get(_)(w):w;t.push(`${a(p)} ${g}`),o=p.split("_")[0]}),t.join(`
`)}function de(t){return t.filter(o=>!(o.startsWith(sourceHeaderPrefix)||o.startsWith(settingsAppliedPrefix)||[settingsMarker,userDataMarker,sourceURLLine,movesMarker].includes(o))).join(`
`).replace(/^\n+/,"").replace(/\n+$/,"")}s.saveDiagramToFile=()=>{const t=de(A(userInputsField).split(`
`)),o=`${sourceHeaderPrefix} Saved: ${s.humanTimestamp()}
${sourceURLLine}

${userDataMarker}

${t}

${Ee()}
`;ue(o,`sankeymatic_${s.fileTimestamp()}_source.txt`)},s.saveDiagramAsJSON=()=>{const t={};skmSettings.forEach((l,p)=>{if(!p.startsWith("internal_")){const _=l[0];t[p]=le(p,_)}});const o=de(A(userInputsField).split(`
`)),a={};s.rememberedMoves.size&&s.rememberedMoves.forEach((l,p)=>{a[p]=l});const i={credits:"Made with SankeyMATIC",timestamp:s.humanTimestamp(),flows:o,settings:t,moves:a};ue(JSON.stringify(i,null,2),`sankeymatic_${s.fileTimestamp()}.json`)},s.process_sankey=(t=null)=>{let[o,a,i]=[0,0,0];const l=new Map;function p(){const n=(c,m,y)=>`<span style="background-color: ${c};" class="color_sample_${m}" title="${c} from d3 color scheme ${y}">&nbsp;</span>`;for(const c of $e.keys()){const m=pe(c),y=A(me(c)),e=Se(m.colorset,y),r=e.map(u=>n(u,e.length,m.d3Name)).join("");h(`theme_${c}_guide`).innerHTML=r,h(`theme_${c}_label`).textContent=m.nickname}}function _(n){const c=n.match(/^-(.*)-$/),m=c!==null;return{trueName:m?c[1]:n,hideLabel:m}}function w(n,c){const m=_(n);if(l.has(m.trueName)){const y=l.get(m.trueName);y.sourceRow>c&&(y.sourceRow=c),y.hideLabel||=m.hideLabel}else l.set(m.trueName,{name:m.trueName,hideLabel:m.hideLabel,sourceRow:c,paintInputs:[]})}function g(n){return l.get(_(n).trueName)}function $(n){w(n.name,n.sourceRow),delete n.sourceRow,reBareColor.test(n.color)&&(n.color=`#${n.color}`);const c=g(n.name);delete n.name,Object.entries(n).forEach(([m,y])=>{typeof y<"u"&&y!==null&&y!==""&&(c[m]=y)})}O.resetAll();const R=A(userInputsField).split(`
`),P=R.map(n=>n.trim().replace(/^\u200B+/,"").replace(/\u200B+$/,"").trim()),T=[],J=new Set,ee=new Set;function k(n,c){T.push({value:n,message:c})}let Y="";P.forEach((n,c)=>{const m=n.match(reMoveLine);if(m!==null){J.add(c);const[e,r,u]=m.slice(-3);s.rememberedMoves.set(e,[Number(r),Number(u)]),ee.add(c);return}const y=n.match(reSettingsValue)??n.match(reSettingsText);if(y!==null){J.add(c);let e=y[1],r=e.replace(/\s+/g,"_");"width height left right top bottom".split(" ").filter(d=>r.endsWith(d)).forEach(d=>{r=r.replace(d,d[0])}),!skmSettings.has(r)&&!/_/.test(r)&&Y.length&&(r=`${Y}_${r}`,e=`${Y} ${e}`),Y=r.split("_")[0];const u=skmSettings.get(r);if(u){const d=y[2],v=u[0],N=v==="contained"?{w:A("size_w"),h:A("size_h")}:{},[M,C]=W(u,d,N);if(M){V(r,v,C),ee.add(c);return}k(d,`Invalid value for <strong>${e}<strong>`)}else k(e,"Not a valid setting name")}});const te=[],B=[],U=[];P.filter((n,c)=>!J.has(c)).forEach((n,c)=>{if(n===""||reCommentLine.test(n))return;let m=n.match(reNodeLine);if(m!==null){$({name:m[1].trim(),color:m[2],opacity:m[3],paintInputs:[m[4],m[5]],sourceRow:c});return}if(m=n.match(reFlowLine),m!==null){const y=m[2].replace(/\s/g,"");if(!S(y)){k(n,"The Amount is not a valid decimal number");return}if(y<=0){k(n,"Amounts must be greater than 0");return}te.push({source:m[1].trim(),target:m[3].trim(),amount:y,sourceRow:c}),o=Math.max(o,(y.split(".")[1]||"").length);return}k(n,"Does not match the format of a Flow or Node or Setting")}),T.forEach(n=>{O.add(`${n.message}: ${ke(n.value)}`,"issue")});const ae=h("layout_reversegraph").checked;te.forEach(n=>{let[c,m]=["",""];const y=n.target.match(reFlowTargetWithSuffix);if(y!==null){const[,r,u]=y,d=u.match(reColorPlusOpacity);d!==null&&(n.target=r,d[1]&&(c=`#${d[1]}`),d[2]&&(m=d[2]))}w(n.source,n.sourceRow),w(n.target,n.sourceRow+.5);const e={index:U.length,source:g(n.source),target:g(n.target),value:n.amount,color:c,opacity:m,hovering:!1,sourceRow:n.sourceRow};ae&&([e.source,e.target]=[e.target,e.source]),U.push(e)}),Array.from(l.values()).sort((n,c)=>n.sourceRow-c.sourceRow).forEach(n=>{const c=n.paintInputs.some(y=>y==="<<"),m=n.paintInputs.some(y=>y===">>");n.paint={[BEFORE]:ae?m:c,[AFTER]:ae?c:m},delete n.paintInputs,n.index=B.length,B.push(n)});const x={};skmSettings.forEach((n,c)=>{const[m,y]=n,e=le(c,m),r=m==="contained"?{w:x.size_w,h:x.size_h}:{},[u,d]=W(n,e,r);if(u){x[c]=d;return}const v=Re(y,m);x[c]=v,V(c,m,v)});const I=h("chart");I.style.height=`${x.size_h}px`,I.style.width=`${x.size_w}px`,[1,2,4,6].forEach(n=>{h(`save_as_png_${n}x`).title=`PNG image file: ${x.size_w*n} x ${x.size_h*n}`});const oe=R.map((n,c)=>ee.has(c)?`${settingsAppliedPrefix}${n}`:n);if(oe[0].startsWith(sourceHeaderPrefix)?(h(userInputsField).value=de(oe),t&&O.add(`Imported <strong>${t}</strong>.`)):h(userInputsField).value=oe.join(`
`),!te.length)return O.add('Enter a list of Flows &mdash; one per line. See the <a href="/manual/" target="_blank">Manual</a> for more help.'),ye(x),null;const[re,j]=x.value_format,H={marks:{group:re==="X"?"":re,decimal:j},decimalPlaces:o,trimString:x.labelvalue_fullprecision?"":"~",prefix:x.value_prefix,suffix:x.value_suffix};if(x.layout_reversegraph)switch(x.flow_inheritfrom){case"source":x.flow_inheritfrom="target";break;case"target":x.flow_inheritfrom="source";break}Ne(B,U,x,H);function z(n){return ce(n,H)}function ne(n,c){const m=z(n.total[c]),y=n.flows[c].filter(u=>!u.isAShadow),e=y.length;if(e===1)return m;const r=y.map(u=>u.value).sort((u,d)=>d-u).map(u=>z(u)).join(" + ");return`<dfn title="${m} from ${e} Flows: ${r}">${m}</dfn>`}const ie=10**(-o-1),q=[],L={[IN]:0,[OUT]:0};B.forEach((n,c)=>{if(n.total[IN]>0&&n.total[OUT]>0){const m=n.total[IN]-n.total[OUT];Math.abs(m)>ie&&q.push({name:n.name,total:{[IN]:ne(n,IN),[OUT]:ne(n,OUT)},difference:z(m)})}else L[IN]+=n.total[IN],L[OUT]+=n.total[OUT];n.value>i&&(a=c,i=n.value)});const X=!q.length;if(["meta_listimbalances","layout_attachto_leading","layout_attachto_trailing","layout_attachto_nearest"].forEach(n=>{h(n).disabled=X}),h("imbalances_area").setAttribute("aria-disabled",X),!X&&x.meta_listimbalances){const n=["<tr><td></td><th>Total In</th><th>Total Out</th><th>Difference</th></tr>"];q.forEach(c=>{n.push(`<tr><td class="nodename">${se(c.name)}</td><td>${c.total[IN]}</td><td>${c.total[OUT]}</td><td>${c.difference}</td></tr>`)}),O.add(`<table class="center_basic">${n.join(`
`)}</table>`,"difference")}let K=`<strong>${B.length} ノード</strong> 間に <strong>${U.length} フロー</strong>  `;if(Math.abs(L[IN]-L[OUT])>ie){const n=L[IN]>L[OUT]?"&gt;":"&lt;";K+=`Total Inputs: <strong>${z(L[IN])}</strong> ${n} Total Outputs: <strong>${z(L[OUT])}</strong>`}else K+=`トータル・インプット = トータル・アウトプット = <strong>${z(L[IN])}</strong> &#9989;`;O.add(K,"total"),p();const G=parseFloat(h(`r${a}`).getAttributeNS(null,"height")),fe=we(d3.format(",.2~f")(G),H.marks),he=ce(i/G,{...H,decimalPlaces:4});return h("scale_figures").innerHTML=`<strong>${he}</strong> per pixel (${z(i)}/${fe}px)`,E(),null},s.process_sankey(),s.loadDiagramFile=async()=>{const t=h("load_diagram_from_file").files;if(t.length===0)return;const o=await t[0].text(),a=t[0].name;if(o.trim().startsWith("{"))try{const i=JSON.parse(o);typeof i.flows=="string"&&(h(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,p])=>{const _=skmSettings.get(l);if(_){const[w,g]=W(_,p,{});w&&V(l,_[0],g)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,p])=>{s.rememberedMoves.set(l,p)})),s.process_sankey(a);return}catch(i){console.warn("File looked like JSON but failed to parse:",i)}h(userInputsField).value=o,s.process_sankey(a)},s.saveCloudProjectUI=async()=>{const t={};skmSettings.forEach((_,w)=>{if(!w.startsWith("internal_")){const g=_[0];t[w]=le(w,g)}});const o=de(A(userInputsField).split(`
`)),a={};s.rememberedMoves.forEach((_,w)=>{a[w]=_});const i={metadata:{saved_at:new Date().toISOString(),generator:"SankeyMATIC",version:"1.0"},settings:t,flows:o,moves:a},[l,p]=await ve(1);window.CloudUI.openSaveModal(i,p)},s.loadCloudProjectUI=()=>{window.CloudUI.openLoadModal(t=>{s.loadProjectData(t)})},s.loadProjectData=t=>{typeof t.flows=="string"&&(h(userInputsField).value=t.flows),t.settings&&typeof t.settings=="object"&&Object.entries(t.settings).forEach(([o,a])=>{const i=skmSettings.get(o);if(i){const[l,p]=W(i,a,{});l&&V(o,i[0],p)}}),t.moves&&typeof t.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(t.moves).forEach(([o,a])=>{s.rememberedMoves.set(o,a)})),s.process_sankey()},window.addEventListener("dataviz-save-trigger",()=>{s.saveDiagramAsJSON()}),window.addEventListener("dataviz-load-trigger",async t=>{if(t.detail&&t.detail.file){const o=t.detail.file,a=await o.text();if(a.trim().startsWith("{"))try{const i=JSON.parse(a);typeof i.flows=="string"&&(h(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,p])=>{const _=skmSettings.get(l);if(_){const[w,g]=W(_,p,{});w&&V(l,_[0],g)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,p])=>{s.rememberedMoves.set(l,p)})),s.process_sankey(o.name);return}catch(i){console.warn("JSON parse error from header load:",i)}h(userInputsField).value=a,s.process_sankey(o.name)}}),window.addEventListener("load",()=>{const o=new URLSearchParams(window.location.search).get("project_id")||window.SKM_PROJECT_ID;if(o){console.log("Found project_id:",o);let a=0;const i=setInterval(async()=>{if(a++,a>50){clearInterval(i),console.error("Timeout waiting for CloudApi/Supabase");return}if(window.CloudApi&&window.datavizSupabase){clearInterval(i);const{data:{session:l}}=await window.datavizSupabase.auth.getSession();if(l){const p=document.createElement("div");p.textContent="Loading Project...",p.style.cssText="position:fixed;top:10px;right:10px;background:#036;color:#fff;padding:15px;border-radius:5px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.3);",document.body.appendChild(p);try{const _=await window.CloudApi.loadProject(o);console.log("Project loaded:",_);let w=_;if(w.data&&!w.flows&&!w.settings&&(w=w.data),typeof w=="string"&&w.trim().startsWith("{"))try{w=JSON.parse(w)}catch{}s.loadProjectData(w);const g=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({path:g},"",g)}catch(_){console.error("Auto-load failed",_),alert("プロジェクトの読み込みに失敗しました: "+_.message)}finally{p.remove()}}else console.warn("No session found for auto-load")}},500)}})})(window==="undefined"?global:window);document.addEventListener("DOMContentLoaded",()=>{const F=document.querySelector("dataviz-tool-header");if(F){const s=(E,Q="info",se=3e3)=>{F.showMessage(E,Q,se)},h=window.saveCloudProjectUI,A=window.loadCloudProjectUI,b=window.replaceGraph,S=async()=>{s("プロジェクトを保存しています...","info");try{await h(),s("プロジェクトが正常に保存されました！","success")}catch(E){console.error("保存失敗:",E),s("プロジェクトの保存に失敗しました。","error",5e3)}},D=async()=>{s("プロジェクトを読み込んでいます...","info");try{await A(),s("プロジェクトが正常に読み込まれました！","success")}catch(E){console.error("読み込み失敗:",E),s("プロジェクトの読み込みに失敗しました。","error",5e3)}},Z=E=>{s(`サンプル (${E}) を読み込んでいます...`,"info");try{b(E),s(`サンプル (${E}) が読み込まれました！`,"success")}catch(Q){console.error("サンプル読み込み失敗:",Q),s(`サンプル (${E}) の読み込みに失敗しました。`,"error",5e3)}};F.setConfig({logoUrl:"/i/SKM-trsp-300.png",buttons:[{label:"プロジェクトを保存",action:S},{label:"プロジェクトを読み込む",action:D},{label:"サンプル: シンプル",action:()=>Z("simple_start")},{label:"サンプル: 決算",action:()=>Z("financial_results")},{label:"ヘルプ",type:"link",href:"/manual/"}]})}});
