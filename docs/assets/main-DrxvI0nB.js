(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const k of document.querySelectorAll('link[rel="modulepreload"]'))E(k);new MutationObserver(k=>{for(const M of k)if(M.type==="childList")for(const L of M.addedNodes)L.tagName==="LINK"&&L.rel==="modulepreload"&&E(L)}).observe(document,{childList:!0,subtree:!0});function f(k){const M={};return k.integrity&&(M.integrity=k.integrity),k.referrerPolicy&&(M.referrerPolicy=k.referrerPolicy),k.crossOrigin==="use-credentials"?M.credentials="include":k.crossOrigin==="anonymous"?M.credentials="omit":M.credentials="same-origin",M}function E(k){if(k.ep)return;k.ep=!0;const M=f(k);fetch(k.href,M)}})();(function(){if(window.location.search){const P=new URLSearchParams(window.location.search).get("project_id");P&&(window.SKM_PROJECT_ID=P,console.log("Rescued project_id:",P))}})();window.skmSettings=new Map([["size_w",["whole",600,[40]]],["size_h",["whole",600,[40]]],["margin_l",["contained",12,[0,"w"]]],["margin_r",["contained",12,[0,"w"]]],["margin_t",["contained",18,[0,"h"]]],["margin_b",["contained",20,[0,"h"]]],["bg_color",["color","#ffffff",[]]],["bg_transparent",["yn","n",[]]],["node_w",["contained",9,[0,"w"]]],["node_h",["whole",50,[0,100]]],["node_spacing",["whole",85,[0,100]]],["node_border",["contained",0,[0,"w"]]],["node_theme",["radio","none",["a","b","c","d","none"]]],["node_color",["color","#888888",[]]],["node_opacity",["decimal",1,[]]],["flow_curvature",["decimal",.5,[]]],["flow_inheritfrom",["radio","none",["source","target","outside-in","none"]]],["flow_color",["color","#999999",[]]],["flow_opacity",["decimal",.45,[]]],["layout_order",["radio","automatic",["automatic","exact"]]],["layout_justifyorigins",["yn","n",[]]],["layout_justifyends",["yn","n",[]]],["layout_reversegraph",["yn","n",[]]],["layout_attachincompletesto",["radio","nearest",["leading","nearest","trailing"]]],["labels_color",["color","#000000",[]]],["labels_highlight",["decimal",.55,[]]],["labels_fontface",["radio","sans-serif",["monospace","sans-serif","serif"]]],["labelname_appears",["yn","y",[]]],["labelname_size",["whole",16,[6]]],["labelname_weight",["radio","400",["100","400","700"]]],["labelvalue_appears",["yn","y",[]]],["labelvalue_fullprecision",["yn","y",[]]],["labelposition_first",["radio","before",["before","after"]]],["labelposition_breakpoint",["breakpoint",9999,[2]]],["value_format",["list",",.",[",.",".,"," ."," ,","X.","X,"]]],["value_prefix",["text","",[0,99]]],["value_suffix",["text","",[0,99]]],["themeoffset_a",["whole",9,[0,9]]],["themeoffset_b",["whole",0,[0,9]]],["themeoffset_c",["whole",0,[0,7]]],["themeoffset_d",["whole",0,[0,11]]],["meta_listimbalances",["yn","y",[]]],["internal_iterations",["whole",25,[0,50]]],["internal_revealshadows",["yn","n",[]]]]);window.reWholeNumber=/^\d+$/;window.reDecimal=/^\d(?:.\d+)?$/;window.reCommentLine=/^(?:'|\/\/)/;window.reYesNo=/^(?:y|yes|n|no)/i;window.reYes=/^(?:y|yes)/i;window.reSettingsValue=/^((?:\w+\s*){1,2}) (#?[\w.-]+)$/;window.reSettingsText=/^((?:\w+\s*){1,2}) '(.*)'$/;window.reMoveLine=/^move (.+) (-?\d(?:.\d+)?), (-?\d(?:.\d+)?)$/;window.sourceHeaderPrefix="// SankeyMATIC diagram inputs -";window.sourceURLLine="// https://sankeymatic.com/build/";window.userDataMarker="// === Nodes and Flows ===";window.movesMarker="// === Moved Nodes ===";window.settingsMarker="// === Settings ===";window.settingsAppliedPrefix="// ✓ ";window.reNodeLine=/^:(.+) #([a-f0-9]{0,6})?(\.\d{1,4})?\s*(>>|<<)*\s*(>>|<<)*$/i;window.reFlowLine=/^(.+)\[([\d\s.+-]+)\](.+)$/;window.reFlowTargetWithSuffix=/^(.+)\s+(#\S+)$/;window.reColorPlusOpacity=/^#([a-f0-9]{3,6})?(\.\d{1,4})?$/i;window.reBareColor=/^(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.reRGBColor=/^#(?:[a-f0-9]{3}|[a-f0-9]{6})$/i;window.colorGray60="#999";window.userInputsField="flows_in";window.IN=13;window.OUT=17;window.BEFORE=19;window.AFTER=23;window.fontMetrics={firefox:{"sans-serif":{dy:.35,top:.55,bot:.25,inner:.35,outer:.35,marginRight:1.4,marginAdjLeft:0},monospace:{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.48,marginAdjLeft:-.08},"*":{dy:.31,top:.3,bot:.25,inner:.35,outer:.35,marginRight:1.35,marginAdjLeft:-.05}},"*":{monospace:{dy:.28,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.45,marginAdjLeft:0},"*":{dy:.29,top:.3,bot:.3,inner:.35,outer:.38,marginRight:1.35,marginAdjLeft:0}}};window.highlightStyles={dark:{orig:{fill:"#fff",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#ffb",stroke:"#440",stroke_width:1,stroke_opacity:.7}},light:{orig:{fill:"#000",stroke:"none",stroke_width:0,stroke_opacity:0},hover:{fill:"#603",stroke:"#fff",stroke_width:1.7,stroke_opacity:.9}}};window.sampleDiagramRecipes=new Map([["default_budget",{name:"Basic Budget",flows:`// Enter Flows between Nodes, like this:
//         Source [AMOUNT] Target

Wages [1500] Budget
Other [250] Budget

Budget [450] Taxes
Budget [420] Housing
Budget [400] Food
Budget [295] Transportation
Budget [25] Savings

// You can set a Node's color, like this:
:Budget #708090
//            ...or a color for a single Flow:
Budget [160] Other Necessities #0F0

// Use the controls below to customize
// your diagram's appearance...`,settings:{size_w:600,node_w:9,node_h:50,node_spacing:85,node_theme:"a",flow_inheritfrom:"outside-in",layout_justifyends:"n",layout_order:"automatic",labelname_size:16,value_prefix:""}}],["election",{name:"Ranked Election",flows:`// Sample Ranked Election diagram

GH - Round 1 [300000] GH - Round 2
EF - Round 1 [220000] EF - Round 2
CD - Round 1 [200000] CD - Round 2
AB - Round 1 [10000] GH - Round 2
AB - Round 1 [25000] EF - Round 2
AB - Round 1 [20000] CD - Round 2

GH - Round 2 [310000] GH - Round 3
EF - Round 2 [245000] EF - Round 3
CD - Round 2 [50000] GH - Round 3
CD - Round 2 [95000] EF - Round 3

// This line sets a custom gray color:
:No further votes #555 <<
AB - Round 1 [20000] No further votes
CD - Round 2 [75000] No further votes`,settings:{size_w:700,node_w:9,node_h:76,node_spacing:85,node_theme:"a",flow_inheritfrom:"source",layout_justifyends:"n",layout_order:"exact",labelname_size:14,value_prefix:""}}],["job_search",{name:"Job Search",flows:`// Sample Job Search diagram:

Applications [4] Interview
Applications [9] Rejected
Applications [4] No Answer

Interview [2] 2nd Interview
Interview [2] No Offer

2nd Interview [2] Offer

Offer [1] Accepted
Offer [1] Declined`,settings:{size_w:700,node_w:5,node_h:50,node_spacing:50,node_theme:"a",flow_inheritfrom:"target",layout_justifyends:"n",layout_order:"automatic",labelname_size:14,value_prefix:""}}],["financial_results",{name:"Financial Results",flows:`Division A [900] Revenue
Division B [750] Revenue
Division C [150] Revenue

Revenue [1000] Gross Profit

Gross Profit [350] Operating Profit
Gross Profit [650] Operating Expenses

Operating Profit [260] Net Profit
Operating Profit [90] Tax

Operating Expenses [640] S G & Admin
Operating Expenses [10] Amortization

Revenue [800] Cost of Sales

// Profit - blue
:Gross Profit #48e <<
:Operating Profit #48e <<
:Net Profit #48e <<

// Expenses - rust
:Operating Expenses #d74 <<
:Tax #d74 <<
:S G & Admin #d74 <<
:Amortization #d74 <<

// Cost - grayish-gold
:Cost of Sales #e6cc91 <<

// main Revenue node: dark grey
:Revenue #444`,settings:{size_w:1e3,node_w:5,node_h:70,node_spacing:70,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"y",layout_order:"automatic",labelname_size:13,value_prefix:"$"}}],["simple_start",{name:"Start Simple",flows:`a [1] b
a [1] c`,settings:{size_w:600,node_w:12,node_h:50,node_spacing:80,node_theme:"none",flow_inheritfrom:"none",layout_justifyends:"n",layout_order:"automatic",labelname_size:15,value_prefix:""}}]]);(function(s){function f(a){return document.getElementById(a)}function E(a){return document.getElementById(a).value}s.togglePanel=a=>{const o=f(a),t=o.tagName==="SPAN"?"inline":"",i=o.style.display==="none"?{display:t,suffix:":",action:"–"}:{display:"none",suffix:"...",action:"+"};return o.style.display=i.display,f(`${a}_hint`).textContent=i.suffix,f(`${a}_indicator`).textContent=i.action,null};function k(a){return f(`${a}_val`)}s.labelNeverBreakpoint=9999,s.updateOutput=a=>{const o=E(a),t=k(a);switch({node_h:"%",node_spacing:"%",node_opacity:".2",flow_curvature:"|",flow_opacity:".2",labels_highlight:".2",labelposition_breakpoint:"never"}[a]){case"|":if(o<=.1){t.textContent="0.00";break}case".2":t.textContent=d3.format(".2f")(o);break;case"%":t.textContent=`${o}%`;break;case"never":t.textContent=Number(o)===s.labelNeverBreakpoint?"∅":o;break;default:t.textContent=o}return null},s.revealVal=a=>{s.updateOutput(a);const o=k(a).classList;return o.remove("fade-init","fade-out"),o.add("fade-in"),null},s.fadeVal=a=>(k(a).classList.replace("fade-in","fade-out"),null);function M(a){return!Number.isNaN(a-parseFloat(a))}function L(a,o,t){return M(a)?Math.min(Math.max(a,o),t):o}function R(a){return document.forms.skm_form.elements[a]}s.checkRadio=a=>{f(a).checked=!0},s.rememberedMoves=new Map,s.resetMovesAndRender=()=>(s.rememberedMoves.clear(),s.process_sankey(),null);function F(){f("reset_all_moved_nodes").disabled=!s.rememberedMoves.size}function G(a){const o=d3.rgb(a),t=(o.r*299+o.g*587+o.b*114)/1e3,i=Math.floor(t>164?.75*t-64:.3*t+192);return d3.rgb(i,i,i)}function Z(a){return a.replaceAll("→","&#8594;").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;").replaceAll(`
`,"<br />")}function c(a){return Number(a.toFixed(5)).toString()}function Q(a,o){return o.group===","?a:a.replaceAll(",","!").replaceAll(".",o.decimal).replaceAll("!",o.group)}function ee(a,o){const t=Q(d3.format(`,.${o.decimalPlaces}${o.trimString}f`)(a),o.marks);return`${o.prefix}${t}${o.suffix}`}function te(a){const o=f("sankey_svg");o.setAttribute("height",a.size_h),o.setAttribute("width",a.size_w),o.setAttribute("class",`svg_background_${a.bg_transparent?"transparent":"default"}`),o.textContent=""}const me=d3.timeFormat("%Y%m%d_%H%M%S");s.fileTimestamp=()=>me(new Date),s.humanTimestamp=()=>new Date().toLocaleString();async function de(a){const o=f("chart"),t={w:o.clientWidth,h:o.clientHeight},i=L(a,1,6),l={w:t.w*i,h:t.h*i},h={x:(l.w-t.w)/(2*i),y:(l.h-t.h)/(2*i)},g=f("png_preview"),w=g.getContext("2d"),_=new XMLSerializer().serializeToString(f("sankey_svg"));return g.width=l.w,g.height=l.h,await(await canvg.Canvg.fromString(w,_,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,scaleWidth:l.w,scaleHeight:l.h,offsetX:h.x,offsetY:h.y})).render(),[l,g.toDataURL("image/png")]}function ve(a,o){const t=document.createElement("a");t.style.display="none",t.href=a,t.download=o,document.body.append(t),t.click(),t.remove()}s.saveDiagramAsPNG=async a=>{const[o,t]=await de(a);ve(t,`sankeymatic_${s.fileTimestamp()}_${o.w}x${o.h}.png`)};function pe(a,o){const t=new Blob([a],{type:"text/plain"}),i=URL.createObjectURL(t);ve(i,o),URL.revokeObjectURL(i)}s.saveDiagramAsSVG=()=>{const a=f("sankey_svg").outerHTML.replace(' id="sankey_svg"',"").replace(/ class="svg_background_[a-z]+"/,"").replace(/>/,`>\r
<title>Your Diagram Title</title>\r
<!-- Generated with SankeyMATIC: ${s.humanTimestamp()} -->\r
`).replace(/><(g|\/g|path|text|rect)/g,`>\r
<$1`);pe(a,`sankeymatic_${s.fileTimestamp()}.svg`)};function be(a){const o=a.source.x+a.source.dx,t=a.target.x,i=a.source.y+a.sy,l=a.target.y+a.ty+a.dy;return a.renderAs="flat",`M${c(o)} ${c(i)}v${c(a.dy)}L${c(t)} ${c(l)}v${c(-a.dy)}z`}function Se(a){return o=>{const t=o.source.y+o.sy+o.dy/2,i=o.target.y+o.ty+o.dy/2,l=o.source.x+o.source.dx,h=o.target.x;if(Math.abs(t-i)<2||Math.abs(h-l)<12)return be(o);o.renderAs="curved";const g=d3.interpolateNumber(l,h),w=g(a),_=g(1-a);return`M${c(l)} ${c(t)}C${c(w)} ${c(t)} ${c(_)} ${c(i)} ${c(h)} ${c(i)}`}}s.settingIsValid=function(o,t,i){const[l,h,g]=o;if(l==="yn"&&reYesNo.test(t))return[!0,reYes.test(t)];if(["radio","list"].includes(l)&&g.includes(t))return[!0,t];if(l==="color"){let v;if(reRGBColor.test(t))v=d3.rgb(t);else if(reBareColor.test(t))v=d3.rgb(`#${t}`);else{const b=d3.color(t);b&&(v=b)}if(v)return[!0,v.formatHex()]}function w(v,[b,C]){return v>=b&&(C===void 0||v<=C)}if(l==="text"){const v=t.replaceAll("''","'");if(w(v.length,g))return[!0,v]}const _=Number(t);if(l==="decimal"&&reDecimal.test(t)&&w(_,[0,1]))return[!0,_];if(["whole","contained","breakpoint"].includes(l)&&reWholeNumber.test(t)){let[v,b]=[0];switch(l){case"whole":[v,b]=g;break;case"contained":b=i[g[1]];break;case"breakpoint":b=h;break}if(w(_,[v,b]))return[!0,_]}return[!1]},s.setValueOnPage=function(o,t,i){switch(t){case"radio":R(o).value=i;break;case"yn":f(o).checked=i;break;default:f(o).value=i}};function ce(a,o){switch(o){case"radio":return R(a).value;case"color":return f(a).value.toLowerCase();case"yn":return f(a)?.checked?"Y":"N";case"list":case"text":return f(a).value;default:return Number(f(a).value)}}function Me(a,o){switch(o){case"whole":case"decimal":case"contained":case"breakpoint":return Number(a);case"yn":return reYes.test(a);default:return a}}function xe(a){return`&quot;<strong>${Z(a)}</strong>&quot;`}const j={areas:new Map([["issue",{id:"issue_messages",class:"errormessage"}],["difference",{id:"imbalance_messages",class:"differencemessage"}],["total",{id:"totals_area",class:""}],["info",{id:"info_messages",class:"okmessage"}]]),add:(a,o="info")=>{const t=j.areas.get(o)||j.areas.get("info"),i=document.createElement("div");i.innerHTML=a,t.class.length&&i.classList.add(t.class),f(t.id).append(i)},resetAll:()=>{Array.from(j.areas.values()).map(a=>a.id).forEach(a=>{f(a).replaceChildren()})}};s.hideReplaceGraphWarning=()=>(f("replace_graph_warning").style.display="none",null),s.replaceGraphConfirmed=()=>{const a=E("demo_graph_chosen"),o=sampleDiagramRecipes.get(a);Object.entries(o.settings).forEach(([l,h])=>{const g=skmSettings.get(l),[w,_]=settingIsValid(g,h,{});w&&setValueOnPage(l,g[0],_)});const t="input_options";f(t).style.display==="none"&&s.togglePanel(t);const i=f(userInputsField);return i.focus(),i.select(),i.setRangeText(o.flows,0,i.selectionEnd,"start"),i.blur(),s.hideReplaceGraphWarning(),s.resetMovesAndRender(),null},s.replaceGraph=a=>{const o=sampleDiagramRecipes.get(a);if(!o)return j.add(`Requested sample diagram ${xe(a)} not found.`,"issue"),null;f("demo_graph_chosen").value=a;const t=E(userInputsField);return Array.from(sampleDiagramRecipes.values()).some(l=>l.flows===t)||t===""?s.replaceGraphConfirmed():(f("replace_graph_warning").style.display="",f("replace_graph_yes").textContent=`はい '${o.name}'と置き換えてください`),null};const ke=new Map([["a",{colorset:d3.schemeCategory10,nickname:"Categories",d3Name:"Category10"}],["b",{colorset:d3.schemeTableau10,nickname:"Tableau10",d3Name:"Tableau10"}],["c",{colorset:d3.schemeDark2,nickname:"Dark",d3Name:"Dark2"}],["d",{colorset:d3.schemeSet3,nickname:"Varied",d3Name:"Set3"}]]);function fe(a){return ke.get(a.toLowerCase())||{colorset:[],nickname:"Invalid Theme",d3Name:"?"}}function $e(a,o){const t=L(o,0,a.length);return a.slice(t).concat(a.slice(0,t))}function he(a){return`themeoffset_${a}`}s.nudgeColorTheme=(a,o)=>{const t=f(he(a)),i=t===null?0:t.value,l=fe(a).colorset.length,h=(l+ +i+ +o)%l;return t.value=h,f(`theme_${a}_radio`).checked=!0,s.process_sankey(),null};function Ae(a,o,t,i){function l(e){return ee(e,i)}const h=d3.select("#svg_scratch").attr("height",t.size_h).attr("width",t.size_w).attr("text-anchor","middle").attr("opacity","0").attr("font-family",t.labels_fontface).attr("font-size",`${t.labelname_size}px`).attr("font-weight",t.labelname_weight);h.selectAll("*").remove();function g(e,r){const m=`bb_${r}`,d=h.append("text").attr("id",m).attr("x",t.size_w/2).attr("y",t.size_h/2).text(e),x=d.node().getBBox();return{w:x.width,h:x.height}}function w(){function e(){return navigator&&/firefox/i.test(navigator.userAgent||navigator.vendor||"")}const r=g("m","em"),m=r.h,d=r.w,x=g("x","ex").w,N=e()?"firefox":"*",A=fontMetrics[N][t.labels_fontface]||fontMetrics[N]["*"],I={dy:A.dy*m,top:A.top*x,bot:A.bot*x,inner:A.inner*d,outer:A.outer*d};return I.lblMarginAfter=t.node_border/2+A.marginRight*I.inner,I.lblMarginBefore=t.node_border/2+(A.marginRight+A.marginAdjLeft)*I.inner,I}const _=w(),v=d3.sankey().nodes(a).flows(o).rightJustifyEndpoints(t.layout_justifyends).leftJustifyOrigins(t.layout_justifyorigins).setup();let b=v.stages();const C=b.length+1;if(C!==s.labelNeverBreakpoint){const e=f("labelposition_breakpoint");e.setAttribute("max",C),(t.labelposition_breakpoint>C||t.labelposition_breakpoint===s.labelNeverBreakpoint)&&(e.value=C,t.labelposition_breakpoint=C),s.labelNeverBreakpoint=C}function T(e){return!e.isAShadow||t.internal_revealshadows}t.labelname_appears&&a.filter(T).filter(e=>!e.hideLabel).forEach(e=>{e.labelText=t.labelvalue_appears?`${e.name}: ${l(e.value)}`:e.name;const r=t.labelposition_first==="before"?e.stage<t.labelposition_breakpoint-1:e.stage>=t.labelposition_breakpoint-1;e.label={dom_id:`label${e.index}`,anchor:r?"end":"start"}});function J(e,r){let m=0;return e.filter(d=>d.labelText).forEach(d=>{const x=g(d.labelText,d.dom_id).w+(r?_.lblMarginBefore:_.lblMarginAfter)+_.outer;m=Math.max(m,x)}),m}function ae(){const e=t.size_w-t.margin_l-t.margin_r,r=t.size_h-t.margin_t-t.margin_b,m=b.length-1,d=b[0].filter(ye=>ye.label?.anchor==="end"),x=b[m].filter(ye=>ye.label?.anchor==="start"),N=d.length>0?J(b[0],!0):t.node_border/2,A=x.length>0?J(b[m],!1):t.node_border/2,I=e-N-A,_e=b.length*t.node_w+m*(t.node_border+5),Re=Math.max(I,_e),Ne=N+A>0?N/(N+A):.5,Oe=I<_e?(I-_e)*Ne:0;return{w:Re,h:r,final_margin_l:t.margin_l+N+Oe}}const S=ae();v.size({w:S.w,h:S.h}).nodeWidth(t.node_w).nodeHeightFactor(t.node_h/100).nodeSpacingFactor(t.node_spacing/100).autoLayout(t.layout_order==="automatic").attachIncompletesTo(t.layout_attachincompletesto).layout(t.internal_iterations),b=v.stages();const Y=t.node_theme==="none"?[t.node_color]:$e(fe(t.node_theme).colorset,t[he(t.node_theme)]),oe=d3.scaleOrdinal(Y),U=t.flow_curvature<=.1,H=U?be:Se(t.flow_curvature),re=t.bg_color.toUpperCase()<"#888",$=t.labels_color.toUpperCase()<"#AAA",z=highlightStyles[$?"dark":"light"];z.orig.fill_opacity=Number(t.labels_highlight),z.hover.fill_opacity=.666+Number(t.labels_highlight)/3;function ne(){return(b.length-1)/2}a.filter(T).forEach(e=>{if(e.dom_id=`r${e.index}`,e.css_class=`for_${e.dom_id}`,e.tooltip=`${e.name}:
${l(e.value)}`,e.opacity=e.opacity||t.node_opacity,typeof e.color>"u"||e.color===""){const r=(e.name.match(/^\s*(\S+)/)||[null,"name-is-blank"])[1];e.color=e.isAShadow?colorGray60:oe(r)}if(e.border_color=re?d3.rgb(e.color).brighter(2):d3.rgb(e.color).darker(2),t.labelname_appears&&!e.hideLabel){const r=e.label.anchor==="end";e.label.x=e.x+(r?-_.lblMarginBefore:e.dx+_.lblMarginAfter),e.label.y=e.y+e.dy/2,e.label.dy=_.dy,z.orig.fill_opacity>0&&(e.label.bg={dom_id:`${e.label.dom_id}_bg`,offset:{x:r?-_.outer:-_.inner,y:-_.top,w:_.inner+_.outer,h:_.top+_.bot},...z.orig})}}),o.filter(T).forEach(e=>{if(e.dom_id=`flow${e.index}`,e.tooltip=`${e.source.name} → ${e.target.name}: ${l(e.value)}`,e.opacity=e.opacity||t.flow_opacity,e.opacity_on_hover=.5+Number(e.opacity)/2,e.color==="")if(e.isAShadow)e.color=colorGray60;else if(e.source.paint[AFTER])e.color=e.source.color;else if(e.target.paint[BEFORE])e.color=e.target.color;else{const r=(e.source.stage+e.target.stage)/2;switch(t.flow_inheritfrom){case"source":e.color=e.source.color;break;case"target":e.color=e.target.color;break;case"outside-in":e.color=r<=ne()?e.source.color:e.target.color;break;case"none":e.color=t.flow_color}}e.fill={flat:e.color,curved:"none"},e.stroke_width={flat:.5,curved:Math.max(1,e.dy)}}),te(t);const ie=d3.select("#sankey_svg");t.bg_transparent||ie.append("rect").attr("height",t.size_h).attr("width",t.size_w).attr("fill",t.bg_color);const D=ie.append("g").attr("transform",`translate(${S.final_margin_l},${t.margin_t})`);function V(e,r,m){d3.select(`#${e.dom_id}`).attr("opacity",r),[e.source,e.target].filter(d=>d.label?.bg).forEach(d=>{d3.select(`#${d.label.bg.dom_id}`).attr("fill",m.fill).attr("fill-opacity",c(m.fill_opacity)).attr("stroke",m.stroke).attr("stroke-width",c(m.stroke_width)).attr("stroke-opacity",c(m.stroke_opacity))})}function B(e,r){r.hovering=!0,V(r,r.opacity_on_hover,z.hover)}function se(e,r){V(r,r.opacity,z.orig),r.hovering=!1}const le=D.append("g").attr("id","sankey_flows").selectAll().data(o.filter(T)).enter().append("path").attr("id",e=>e.dom_id).attr("d",H).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>c(e.stroke_width[e.renderAs])).attr("stroke",e=>e.color).attr("opacity",e=>e.opacity).on("mouseover",B).on("mouseout",se).sort((e,r)=>e.isAShadow-r.isAShadow||r.dy-e.dy);le.append("title").text(e=>e.tooltip);function q(e){return e.every(r=>r===0)}function O(e){const r=a[e],m=r.move[0]*(t.layout_reversegraph?-1:1),d=S.w-r.dx,x=S.h-r.dy;r.x=Math.max(0,Math.min(d,r.origPos.x+d*m)),r.y=Math.max(0,Math.min(x,r.origPos.y+x*r.move[1])),d3.selectAll(`#sankey_svg .${r.css_class}`).attr("transform",q(r.move)?null:`translate(${c(r.x-r.origPos.x)},${c(r.y-r.origPos.y)})`)}function X(e){e.lastPos={x:e.x,y:e.y}}function K(e){X(e),q(e.move)?s.rememberedMoves.delete(e.name):s.rememberedMoves.set(e.name,e.move),F()}function W(){v.relayout(),le.attr("d",H).attr("fill",e=>e.fill[e.renderAs]).attr("stroke-width",e=>c(e.stroke_width[e.renderAs]))}function ge(e,r){const m=G(t.bg_color);let d=D.select("#helper_layer");if(d.nodes.length||(d=D.insert("g","#sankey_nodes").attr("id","helper_layer").attr("fill",m).attr("fill-opacity",.5).attr("stroke","none")),d.append("path").attr("id","helper_lines").attr("d",`M0 ${c(r.lastPos.y)} h${c(S.w)} m0 ${c(r.dy)} H0M${c(r.lastPos.x)} 0 v${c(S.h)} m${c(r.dx)} 0 V0`).attr("stroke",m).attr("stroke-width",1).attr("stroke-dasharray","1 3").attr("stroke-opacity",.7),d.append("rect").attr("id","helper_original_rect").attr("x",c(r.origPos.x)).attr("y",c(r.origPos.y)).attr("height",c(r.dy)).attr("width",c(r.dx)).attr("fill",r.color).attr("fill-opacity",.3),!(e.sourceEvent&&e.sourceEvent.shiftKey)){const x=d.append("g").attr("id","helper_shift_hints").attr("font-size","14px").attr("font-weight","400");(S.h>350?[.05,.95]:[.4]).forEach(A=>{x.append("text").attr("text-anchor","middle").attr("x",S.w/2).attr("y",S.h*A).text("Hold down Shift to move in only one direction")})}return null}function we(e,r){let m=e.x,d=e.y;const x=f("layout_reversegraph").checked;if(e.sourceEvent&&e.sourceEvent.shiftKey){Math.abs(m-r.lastPos.x)>Math.abs(d-r.lastPos.y)?d=r.lastPos.y:m=r.lastPos.x;const N=D.select("#helper_shift_hints");N.nodes&&N.remove()}return r.move=[(x?-1:1)*((m-r.origPos.x)/(S.w-r.dx)),S.h===r.dy?0:(d-r.origPos.y)/(S.h-r.dy)],O(r.index),W(),null}function n(e,r){const m=D.select("#helper_layer");return m.nodes&&m.remove(),K(r),o.filter(d=>d.hovering).forEach(d=>{se(null,d)}),W(),null}function u(e,r){return r.move=[0,0],O(r.index),K(r),W(),null}const p=D.append("g").attr("id","sankey_nodes").selectAll(".node").data(a.filter(T)).enter().append("g").attr("class","node").call(d3.drag().on("start",ge).on("drag",we).on("end",n)).on("dblclick",u);t.node_border&&p.append("rect").attr("id",e=>`${e.dom_id}_border`).attr("class",e=>e.css_class).attr("x",e=>c(e.x)).attr("y",e=>c(e.y)).attr("height",e=>c(e.dy)).attr("width",e=>c(e.dx)).attr("stroke",e=>e.border_color).attr("stroke-width",t.node_border).attr("fill","none"),p.append("rect").attr("id",e=>e.dom_id).attr("class",e=>e.css_class).attr("x",e=>c(e.x)).attr("y",e=>c(e.y)).attr("height",e=>c(e.dy)).attr("width",e=>c(e.dx)).attr("fill",e=>e.color).attr("fill-opacity",e=>e.opacity).append("title").text(e=>e.tooltip);const y=D.append("g").attr("id","sankey_labels").attr("font-family",t.labels_fontface).attr("font-size",`${t.labelname_size}px`).attr("font-weight",t.labelname_weight).attr("fill",t.labels_color);if(t.labelname_appears&&(y.selectAll().data(a.filter(T)).enter().filter(e=>!e.hideLabel).append("text").attr("id",e=>e.label.dom_id).attr("class",e=>e.css_class).attr("text-anchor",e=>e.label.anchor).attr("x",e=>c(e.label.x)).attr("y",e=>c(e.label.y)).attr("dy",e=>e.label.dy).text(e=>e.labelText),a.filter(T).filter(e=>e.label?.bg).forEach(e=>{const r=`#${e.label.dom_id}`,m=y.select(r).node().getBBox(),d=e.label.bg;y.insert("rect",r).attr("id",d.dom_id).attr("class",e.css_class).attr("x",c(m.x+d.offset.x)).attr("y",c(m.y+d.offset.y)).attr("width",c(m.width+d.offset.w)).attr("height",c(m.height+d.offset.h)).attr("rx",c(t.labelname_size/4)).attr("fill",d.fill).attr("fill-opacity",c(d.fill_opacity)).attr("stroke",d.stroke).attr("stroke-width",c(d.stroke_width)).attr("stroke-opacity",c(d.stroke_opacity))})),s.rememberedMoves.size){const e=new Set(s.rememberedMoves.keys());a.filter(T).filter(r=>e.has(r.name)).forEach(r=>{r.move=s.rememberedMoves.get(r.name),O(r.index),X(r),e.delete(r.name)}),e.forEach(r=>{s.rememberedMoves.delete(r)}),W()}}function Ee(){const a=[];s.rememberedMoves.size&&(a.push(movesMarker,""),s.rememberedMoves.forEach((l,h)=>{a.push(`move ${h} ${c(l[0])}, ${c(l[1])}`)}),a.push(""));let o="";function t(l){const h=o.length;return(h&&l.startsWith(`${o}_`)?`  ${l.substring(h+1)}`:l).replaceAll("_"," ")}const i=new Map([["list",l=>`'${l}'`],["text",l=>`'${l.replaceAll("'","''")}'`]]);return a.push(settingsMarker,""),skmSettings.forEach((l,h)=>{if(h.startsWith("internal_"))return;const g=l[0],w=ce(h,g),_=i.has(g)?i.get(g)(w):w;a.push(`${t(h)} ${_}`),o=h.split("_")[0]}),a.join(`
`)}function ue(a){return a.filter(o=>!(o.startsWith(sourceHeaderPrefix)||o.startsWith(settingsAppliedPrefix)||[settingsMarker,userDataMarker,sourceURLLine,movesMarker].includes(o))).join(`
`).replace(/^\n+/,"").replace(/\n+$/,"")}s.saveDiagramToFile=()=>{const a=ue(E(userInputsField).split(`
`)),o=`${sourceHeaderPrefix} Saved: ${s.humanTimestamp()}
${sourceURLLine}

${userDataMarker}

${a}

${Ee()}
`;pe(o,`sankeymatic_${s.fileTimestamp()}_source.txt`)},s.saveDiagramAsJSON=()=>{const a={};skmSettings.forEach((l,h)=>{if(!h.startsWith("internal_")){const g=l[0];a[h]=ce(h,g)}});const o=ue(E(userInputsField).split(`
`)),t={};s.rememberedMoves.size&&s.rememberedMoves.forEach((l,h)=>{t[h]=l});const i={credits:"Made with SankeyMATIC",timestamp:s.humanTimestamp(),flows:o,settings:a,moves:t};pe(JSON.stringify(i,null,2),`sankeymatic_${s.fileTimestamp()}.json`)},s.process_sankey=(a=null)=>{let[o,t,i]=[0,0,0];const l=new Map;function h(){const n=(u,p,y)=>`<span style="background-color: ${u};" class="color_sample_${p}" title="${u} from d3 color scheme ${y}">&nbsp;</span>`;for(const u of ke.keys()){const p=fe(u),y=E(he(u)),e=$e(p.colorset,y),r=e.map(m=>n(m,e.length,p.d3Name)).join("");f(`theme_${u}_guide`).innerHTML=r,f(`theme_${u}_label`).textContent=p.nickname}}function g(n){const u=n.match(/^-(.*)-$/),p=u!==null;return{trueName:p?u[1]:n,hideLabel:p}}function w(n,u){const p=g(n);if(l.has(p.trueName)){const y=l.get(p.trueName);y.sourceRow>u&&(y.sourceRow=u),y.hideLabel||=p.hideLabel}else l.set(p.trueName,{name:p.trueName,hideLabel:p.hideLabel,sourceRow:u,paintInputs:[]})}function _(n){return l.get(g(n).trueName)}function v(n){w(n.name,n.sourceRow),delete n.sourceRow,reBareColor.test(n.color)&&(n.color=`#${n.color}`);const u=_(n.name);delete n.name,Object.entries(n).forEach(([p,y])=>{typeof y<"u"&&y!==null&&y!==""&&(u[p]=y)})}j.resetAll();const b=E(userInputsField).split(`
`),C=b.map(n=>n.trim().replace(/^\u200B+/,"").replace(/\u200B+$/,"").trim()),T=[],J=new Set,ae=new Set;function S(n,u){T.push({value:n,message:u})}let Y="";C.forEach((n,u)=>{const p=n.match(reMoveLine);if(p!==null){J.add(u);const[e,r,m]=p.slice(-3);s.rememberedMoves.set(e,[Number(r),Number(m)]),ae.add(u);return}const y=n.match(reSettingsValue)??n.match(reSettingsText);if(y!==null){J.add(u);let e=y[1],r=e.replace(/\s+/g,"_");"width height left right top bottom".split(" ").filter(d=>r.endsWith(d)).forEach(d=>{r=r.replace(d,d[0])}),!skmSettings.has(r)&&!/_/.test(r)&&Y.length&&(r=`${Y}_${r}`,e=`${Y} ${e}`),Y=r.split("_")[0];const m=skmSettings.get(r);if(m){const d=y[2],x=m[0],N=x==="contained"?{w:E("size_w"),h:E("size_h")}:{},[A,I]=settingIsValid(m,d,N);if(A){setValueOnPage(r,x,I),ae.add(u);return}S(d,`Invalid value for <strong>${e}<strong>`)}else S(e,"Not a valid setting name")}});const oe=[],U=[],H=[];C.filter((n,u)=>!J.has(u)).forEach((n,u)=>{if(n===""||reCommentLine.test(n))return;let p=n.match(reNodeLine);if(p!==null){v({name:p[1].trim(),color:p[2],opacity:p[3],paintInputs:[p[4],p[5]],sourceRow:u});return}if(p=n.match(reFlowLine),p!==null){const y=p[2].replace(/\s/g,"");if(!M(y)){S(n,"The Amount is not a valid decimal number");return}if(y<=0){S(n,"Amounts must be greater than 0");return}oe.push({source:p[1].trim(),target:p[3].trim(),amount:y,sourceRow:u}),o=Math.max(o,(y.split(".")[1]||"").length);return}S(n,"Does not match the format of a Flow or Node or Setting")}),T.forEach(n=>{j.add(`${n.message}: ${xe(n.value)}`,"issue")});const re=f("layout_reversegraph").checked;oe.forEach(n=>{let[u,p]=["",""];const y=n.target.match(reFlowTargetWithSuffix);if(y!==null){const[,r,m]=y,d=m.match(reColorPlusOpacity);d!==null&&(n.target=r,d[1]&&(u=`#${d[1]}`),d[2]&&(p=d[2]))}w(n.source,n.sourceRow),w(n.target,n.sourceRow+.5);const e={index:H.length,source:_(n.source),target:_(n.target),value:n.amount,color:u,opacity:p,hovering:!1,sourceRow:n.sourceRow};re&&([e.source,e.target]=[e.target,e.source]),H.push(e)}),Array.from(l.values()).sort((n,u)=>n.sourceRow-u.sourceRow).forEach(n=>{const u=n.paintInputs.some(y=>y==="<<"),p=n.paintInputs.some(y=>y===">>");n.paint={[BEFORE]:re?p:u,[AFTER]:re?u:p},delete n.paintInputs,n.index=U.length,U.push(n)});const $={};skmSettings.forEach((n,u)=>{const[p,y]=n,e=ce(u,p),r=p==="contained"?{w:$.size_w,h:$.size_h}:{},[m,d]=settingIsValid(n,e,r);if(m){$[u]=d;return}const x=Me(y,p);$[u]=x,setValueOnPage(u,p,x)});const z=f("chart");z.style.height=`${$.size_h}px`,z.style.width=`${$.size_w}px`,[1,2,4,6].forEach(n=>{f(`save_as_png_${n}x`).title=`PNG image file: ${$.size_w*n} x ${$.size_h*n}`});const ne=b.map((n,u)=>ae.has(u)?`${settingsAppliedPrefix}${n}`:n);if(ne[0].startsWith(sourceHeaderPrefix)?(f(userInputsField).value=ue(ne),a&&j.add(`Imported <strong>${a}</strong>.`)):f(userInputsField).value=ne.join(`
`),!oe.length)return j.add('Enter a list of Flows &mdash; one per line. See the <a href="/manual/" target="_blank">Manual</a> for more help.'),te($),null;const[ie,D]=$.value_format,V={marks:{group:ie==="X"?"":ie,decimal:D},decimalPlaces:o,trimString:$.labelvalue_fullprecision?"":"~",prefix:$.value_prefix,suffix:$.value_suffix};if($.layout_reversegraph)switch($.flow_inheritfrom){case"source":$.flow_inheritfrom="target";break;case"target":$.flow_inheritfrom="source";break}Ae(U,H,$,V);function B(n){return ee(n,V)}function se(n,u){const p=B(n.total[u]),y=n.flows[u].filter(m=>!m.isAShadow),e=y.length;if(e===1)return p;const r=y.map(m=>m.value).sort((m,d)=>d-m).map(m=>B(m)).join(" + ");return`<dfn title="${p} from ${e} Flows: ${r}">${p}</dfn>`}const le=10**(-o-1),q=[],O={[IN]:0,[OUT]:0};U.forEach((n,u)=>{if(n.total[IN]>0&&n.total[OUT]>0){const p=n.total[IN]-n.total[OUT];Math.abs(p)>le&&q.push({name:n.name,total:{[IN]:se(n,IN),[OUT]:se(n,OUT)},difference:B(p)})}else O[IN]+=n.total[IN],O[OUT]+=n.total[OUT];n.value>i&&(t=u,i=n.value)});const X=!q.length;if(["meta_listimbalances","layout_attachto_leading","layout_attachto_trailing","layout_attachto_nearest"].forEach(n=>{f(n).disabled=X}),f("imbalances_area").setAttribute("aria-disabled",X),!X&&$.meta_listimbalances){const n=["<tr><td></td><th>Total In</th><th>Total Out</th><th>Difference</th></tr>"];q.forEach(u=>{n.push(`<tr><td class="nodename">${Z(u.name)}</td><td>${u.total[IN]}</td><td>${u.total[OUT]}</td><td>${u.difference}</td></tr>`)}),j.add(`<table class="center_basic">${n.join(`
`)}</table>`,"difference")}let K=`<strong>${U.length} ノード</strong> 間に <strong>${H.length} フロー</strong>  `;if(Math.abs(O[IN]-O[OUT])>le){const n=O[IN]>O[OUT]?"&gt;":"&lt;";K+=`Total Inputs: <strong>${B(O[IN])}</strong> ${n} Total Outputs: <strong>${B(O[OUT])}</strong>`}else K+=`トータル・インプット = トータル・アウトプット = <strong>${B(O[IN])}</strong> &#9989;`;j.add(K,"total"),h();const W=parseFloat(f(`r${t}`).getAttributeNS(null,"height")),ge=Q(d3.format(",.2~f")(W),V.marks),we=ee(i/W,{...V,decimalPlaces:4});return f("scale_figures").innerHTML=`<strong>${we}</strong> per pixel (${B(i)}/${ge}px)`,F(),null},s.process_sankey(),s.loadDiagramFile=async()=>{const a=f("load_diagram_from_file").files;if(a.length===0)return;const o=await a[0].text(),t=a[0].name;if(o.trim().startsWith("{"))try{const i=JSON.parse(o);typeof i.flows=="string"&&(f(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,h])=>{const g=skmSettings.get(l);if(g){const[w,_]=settingIsValid(g,h,{});w&&setValueOnPage(l,g[0],_)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,h])=>{s.rememberedMoves.set(l,h)})),s.process_sankey(t);return}catch(i){console.warn("File looked like JSON but failed to parse:",i)}f(userInputsField).value=o,s.process_sankey(t)},s.saveCloudProjectUI=async()=>{const a={};skmSettings.forEach((g,w)=>{if(!w.startsWith("internal_")){const _=g[0];a[w]=ce(w,_)}});const o=ue(E(userInputsField).split(`
`)),t={};s.rememberedMoves.forEach((g,w)=>{t[w]=g});const i={metadata:{saved_at:new Date().toISOString(),generator:"SankeyMATIC",version:"1.0"},settings:a,flows:o,moves:t},[l,h]=await de(1);window.CloudUI.openSaveModal(i,h)},s.loadCloudProjectUI=()=>{window.CloudUI.openLoadModal(a=>{s.loadProjectData(a)})},s.loadProjectData=a=>{typeof a.flows=="string"&&(f(userInputsField).value=a.flows),a.settings&&typeof a.settings=="object"&&Object.entries(a.settings).forEach(([o,t])=>{const i=skmSettings.get(o);if(i){const[l,h]=settingIsValid(i,t,{});l&&setValueOnPage(o,i[0],h)}}),a.moves&&typeof a.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(a.moves).forEach(([o,t])=>{s.rememberedMoves.set(o,t)})),s.process_sankey()},window.addEventListener("dataviz-save-trigger",()=>{s.saveDiagramAsJSON()}),window.addEventListener("dataviz-load-trigger",async a=>{if(a.detail&&a.detail.file){const o=a.detail.file,t=await o.text();if(t.trim().startsWith("{"))try{const i=JSON.parse(t);typeof i.flows=="string"&&(f(userInputsField).value=i.flows),i.settings&&typeof i.settings=="object"&&Object.entries(i.settings).forEach(([l,h])=>{const g=skmSettings.get(l);if(g){const[w,_]=settingIsValid(g,h,{});w&&setValueOnPage(l,g[0],_)}}),i.moves&&typeof i.moves=="object"&&(s.rememberedMoves.clear(),Object.entries(i.moves).forEach(([l,h])=>{s.rememberedMoves.set(l,h)})),s.process_sankey(o.name);return}catch(i){console.warn("JSON parse error from header load:",i)}f(userInputsField).value=t,s.process_sankey(o.name)}}),window.addEventListener("load",()=>{const o=new URLSearchParams(window.location.search).get("project_id")||window.SKM_PROJECT_ID;if(o){console.log("Found project_id:",o);let t=0;const i=setInterval(async()=>{if(t++,t>50){clearInterval(i),console.error("Timeout waiting for CloudApi/Supabase");return}if(window.CloudApi&&window.datavizSupabase){clearInterval(i);const{data:{session:l}}=await window.datavizSupabase.auth.getSession();if(l){const h=document.createElement("div");h.textContent="Loading Project...",h.style.cssText="position:fixed;top:10px;right:10px;background:#036;color:#fff;padding:15px;border-radius:5px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.3);",document.body.appendChild(h);try{const g=await window.CloudApi.loadProject(o);console.log("Project loaded:",g);let w=g;if(w.data&&!w.flows&&!w.settings&&(w=w.data),typeof w=="string"&&w.trim().startsWith("{"))try{w=JSON.parse(w)}catch{}s.loadProjectData(w);const _=window.location.protocol+"//"+window.location.host+window.location.pathname;window.history.replaceState({path:_},"",_)}catch(g){console.error("Auto-load failed",g),window.toolHeaderInstance?.showMessage("プロジェクトの自動読み込みに失敗しました: "+g.message,"error",5e3)}finally{h.remove()}}else console.warn("No session found for auto-load")}},500)}})})(window==="undefined"?global:window);const Le=""+new URL("SKM-trsp-300-DUBTLorw.png",import.meta.url).href;document.addEventListener("DOMContentLoaded",()=>{const P=document.querySelector("dataviz-tool-header");if(P){window.toolHeaderInstance=P;const s=(R,F="info",G=3e3)=>{P.showMessage(R,F,G)},f=window.saveCloudProjectUI,E=window.loadCloudProjectUI,k=async()=>{s("プロジェクトを保存しています...","info");try{await f()}catch(R){console.error("保存失敗:",R)}},M=async()=>{s("プロジェクトを読み込んでいます...","info");try{await E()}catch(R){console.error("読み込み失敗:",R)}},L=R=>{s(`サンプル (${R}) を読み込んでいます...`,"info");try{const F=window.sampleDiagramRecipes.get(R);if(!F)throw new Error(`Sample diagram '${R}' not found.`);Object.entries(F.settings).forEach(([Q,ee])=>{const te=window.skmSettings.get(Q),[me,de]=window.settingIsValid(te,ee,{});me&&window.setValueOnPage(Q,te[0],de)});const G="input_options",Z=document.getElementById(G);Z&&Z.style.display==="none"&&window.togglePanel(G);const c=document.getElementById(window.userInputsField);if(!c)throw new Error(`Flows input element '${window.userInputsField}' not found.`);c.focus(),c.select(),c.setRangeText(F.flows,0,c.selectionEnd,"start"),c.blur(),window.resetMovesAndRender(),s(`サンプル (${R}) が読み込まれました！`,"success")}catch(F){console.error("サンプル読み込み失敗:",F),s(`サンプル (${R}) の読み込みに失敗しました。`,"error",5e3)}};P.setConfig({backgroundColor:"#035",logo:{type:"image-and-text",src:Le,text:"SankeyMATIC",alt:"SankeyMATIC logo",textClass:"font-bold text-lg",imgClass:"mr-2"},buttons:[{label:"プロジェクトを保存",action:k},{label:"プロジェクトを読み込む",action:M},{label:"サンプル",type:"dropdown",items:[{label:"シンプル",action:()=>L("simple_start")},{label:"決算",action:()=>L("financial_results")},{label:"就職・転職活動",action:()=>L("job_search")},{label:"選好投票",action:()=>L("election")},{label:"予算",action:()=>L("default_budget")}]}]})}});
